<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORTEX | Multi-Agent DeFi Trading System</title>
    <style>
        @font-face {
            font-family: "Alliance No.1";
            src: url("assets/fonts/Degarism Studio - Alliance No.1 Light.otf") format("opentype");
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: "Alliance No.2";
            src: url("assets/fonts/Degarism Studio - Alliance No.2 Light.otf") format("opentype");
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        :root {
            --bg: #ffffff;
            --fg: #080808;
            --dim: #222222;
            --border: #000000;
            --accent: #000000;
            --green: #00aa00;
            --red: #cc0000;
            --font-main: "Alliance No.1", sans-serif;
            --font-mono: "Alliance No.2", sans-serif;
            --spacing: 1rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg);
            color: var(--fg);
            font-family: var(--font-mono);
            font-size: 15px;
            line-height: 1.4;
            overflow-x: hidden;
            width: 100vw;
            min-height: 100vh;
        }

        /* Utility Classes */
        .serif { font-family: var(--font-main); }
        .uppercase { text-transform: uppercase; }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-dim { color: var(--dim); }
        .border-b { border-bottom: 1px solid var(--border); }
        .border-t { border-top: 1px solid var(--border); }
        .border-r { border-right: 1px solid var(--border); }
        .border-l { border-left: 1px solid var(--border); }
        .pad { padding: var(--spacing); }
        .pad-sm { padding: 0.5rem; }
        .flex { display: flex; }
        .grid { display: grid; }
        .hidden { display: none; }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            min-height: 100vh;
            position: relative;
            z-index: 2;
        }

        /* Scanline Effect */
        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.02), transparent);
            pointer-events: none;
            animation: scanline 8s linear infinite;
            z-index: 100;
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        /* Ticker */
        .ticker {
            overflow: hidden;
            white-space: nowrap;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            color: var(--dim);
            background: #f5f5f5;
        }

        .ticker-content {
            display: inline-block;
            animation: marquee 30s linear infinite;
        }

        .ticker-item {
            display: inline-block;
            margin-right: 3rem;
        }

        .ticker-item .price {
            color: var(--fg);
            margin-left: 0.5rem;
        }

        .ticker-item .change.up { color: var(--green); }
        .ticker-item .change.down { color: var(--red); }

        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Header */
        header {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto auto auto;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-family: var(--font-main);
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            padding: 1rem;
            gap: 8px;
        }

        .logo-img {
            height: 78px;
            width: auto;
            display: block;
        }

        .logo span {
            font-size: 0.5em;
            font-family: var(--font-mono);
            color: var(--dim);
        }

        .nav-item {
            border-left: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 1.5rem;
            text-transform: capitalize;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--fg);
            color: var(--bg);
        }

        a.nav-item { text-decoration: none; color: var(--fg); }
        a.nav-item:hover { color: var(--bg); }

        /* Main Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            min-height: calc(100vh - 100px);
        }

        .panel {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .panel:last-child {
            border-right: none;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
            align-self: start;
        }

        .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            text-transform: capitalize;
            background: #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        /* Left Panel - Agent Status */
        .agent-card {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .agent-card:hover {
            background: #f0f0f0;
        }

        .agent-card.expanded {
            background: #f0f0f0;
        }

        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .agent-name {
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .agent-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--green);
        }

        .agent-status.inactive { background: var(--dim); }
        .agent-status.warning { background: #ffaa00; }

        .agent-meta {
            font-size: 0.65rem;
            color: var(--dim);
            margin-bottom: 0.5rem;
        }

        .agent-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.7rem;
        }

        .metric-label {
            color: var(--dim);
        }

        .metric-value {
            text-align: right;
        }

        .agent-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-bottom: 1px solid var(--border);
        }

        .agent-expand.open {
            max-height: 600px;
        }

        .agent-expand-inner {
            padding: 1rem;
            background: #fafafa;
            position: relative;
        }

        .agent-expand-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 1rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dim);
        }

        .agent-expand-close:hover {
            border-color: var(--fg);
            color: var(--fg);
        }

        /* Center Panel - Portfolio & Trades */
        .portfolio-summary {
            padding: 2rem;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .portfolio-value {
            font-family: var(--font-main);
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .portfolio-change {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .portfolio-change.positive { color: var(--green); }
        .portfolio-change.negative { color: var(--red); }

        .time-filters {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .time-filter {
            padding: 0.25rem 0.75rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--dim);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-filter:hover, .time-filter.active {
            border-color: var(--fg);
            color: var(--fg);
        }

        /* Trades Table */
        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tab-group {
            display: flex;
        }

        .tab {
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            text-transform: capitalize;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--fg); }
        .tab.active {
            color: var(--fg);
            border-bottom-color: var(--fg);
        }

        .trade-row {
            display: grid;
            grid-template-columns: 1fr 80px 80px 80px;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .trade-row:hover {
            background: #f0f0f0;
        }

        .trade-row.expanded {
            background: #f5f5f5;
            border-bottom: none;
        }

        .trade-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 300ms ease;
            background: #fafafa;
            border-bottom: 1px solid var(--border);
        }

        .trade-expand.open {
            max-height: 800px;
        }

        .trade-expand-inner {
            padding: 1.25rem;
            position: relative;
        }

        .trade-expand-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: 1px solid var(--border);
            color: var(--dim);
            font-size: 1.1rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .trade-expand-close:hover {
            color: var(--fg);
            border-color: var(--fg);
        }

        .trade-expand .trade-detail-grid {
            gap: 1rem;
        }

        .trade-expand .detail-section {
            margin-bottom: 1rem;
        }

        .trade-expand .consensus-grid {
            grid-template-columns: repeat(5, 1fr);
        }

        .trade-expand-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .trade-row-header {
            background: #f5f5f5;
            color: var(--dim);
            font-size: 0.65rem;
            text-transform: uppercase;
        }

        .trade-pair {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trade-pair-logo {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .trade-type {
            font-size: 0.6rem;
            color: var(--dim);
        }

        .trade-type.long { color: var(--green); }
        .trade-type.short { color: var(--red); }

        /* Right Panel - News & Sentiment */
        /* ═══ Market Intelligence ═══ */
        .mi-live-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.45rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.58rem;
            font-family: var(--font-mono);
            color: var(--dim);
            background: #fafafa;
        }
        .mi-live-bar .mi-pulse {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--green);
            animation: mi-pulse 1.8s infinite;
        }
        @keyframes mi-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(0,170,0,0.4); }
            50% { opacity: 0.6; box-shadow: 0 0 0 4px rgba(0,170,0,0); }
        }
        .mi-live-bar .mi-src {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }
        .mi-live-bar .mi-src-dot {
            width: 5px; height: 5px;
            border-radius: 50%;
            display: inline-block;
        }
        .mi-live-bar .mi-update {
            margin-left: auto;
            font-size: 0.52rem;
            color: var(--dim);
        }

        .mi-sentiment-strip {
            display: flex;
            height: 3px;
            width: 100%;
        }
        .mi-sentiment-strip .mi-ss-bull { background: var(--green); }
        .mi-sentiment-strip .mi-ss-bear { background: var(--red); }
        .mi-sentiment-strip .mi-ss-neut { background: var(--border); }

        .mi-filters {
            display: flex;
            gap: 0.25rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        .mi-filter-btn {
            font-family: var(--font-mono);
            font-size: 0.58rem;
            padding: 0.2rem 0.55rem;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--dim);
            cursor: pointer;
            font-weight: 500;
            letter-spacing: 0.03em;
            transition: all 0.15s;
        }
        .mi-filter-btn:hover { border-color: var(--fg); color: var(--fg); }
        .mi-filter-btn.active { background: var(--fg); color: var(--bg); border-color: var(--fg); }

        .mi-feed { overflow-y: auto; flex: 1; min-height: 0; }

        .mi-item {
            padding: 0.7rem 0.75rem;
            border-bottom: 1px solid var(--border);
            border-left: 3px solid transparent;
            cursor: pointer;
            transition: background 0.15s, border-left-color 0.15s;
        }
        .mi-item:hover { background: #f7f7f7; }
        .mi-item.expanded { background: #f4f4f4; }
        .mi-item.src-cc { border-left-color: #0066cc; }
        .mi-item.src-nd { border-left-color: #555; }
        .mi-item.src-cp { border-left-color: #e65100; }
        .mi-item.fresh { animation: mi-slide-in 0.4s ease-out; }

        @keyframes mi-slide-in {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .mi-item-head {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            margin-bottom: 0.3rem;
        }
        .mi-item-src {
            font-size: 0.55rem;
            color: var(--dim);
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.03em;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .mi-item-time {
            font-size: 0.52rem;
            color: var(--dim);
            font-family: var(--font-mono);
        }
        .mi-badge-new {
            font-size: 0.42rem;
            font-weight: 700;
            color: var(--green);
            border: 1px solid var(--green);
            padding: 0.04rem 0.22rem;
            font-family: var(--font-mono);
            letter-spacing: 0.05em;
        }
        .mi-badge-api {
            font-size: 0.5rem;
            padding: 0.1rem 0.3rem;
            font-family: var(--font-mono);
            font-weight: 700;
            letter-spacing: 0.05em;
            margin-left: auto;
            color: #fff;
        }
        .mi-badge-api.cc { background: #0066cc; }
        .mi-badge-api.nd { background: #555; }
        .mi-badge-api.cp { background: #e65100; }

        .mi-item-title {
            font-size: 0.75rem;
            line-height: 1.35;
            font-weight: 500;
            margin-bottom: 0.35rem;
        }
        .mi-item-foot {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .mi-sent {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            font-size: 0.5rem;
            text-transform: uppercase;
            border: 1px solid;
            font-weight: 600;
            letter-spacing: 0.04em;
        }
        .mi-sent.bullish { color: var(--green); border-color: var(--green); }
        .mi-sent.bearish { color: var(--red); border-color: var(--red); }
        .mi-sent.neutral { color: var(--dim); border-color: var(--dim); }

        .mi-impact {
            font-size: 0.5rem;
            font-family: var(--font-mono);
            color: var(--dim);
            padding: 0.08rem 0.3rem;
            border: 1px solid var(--border);
        }
        .mi-agent {
            font-size: 0.55rem;
            color: var(--dim);
            margin-top: 0.2rem;
            line-height: 1.3;
            font-style: italic;
        }

        /* MI Expansion Panel */
        .mi-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 350ms ease;
            border-bottom: 1px solid var(--border);
        }
        .mi-expand.open { max-height: 700px; }
        .mi-expand-inner {
            padding: 0.85rem 0.75rem 1rem;
            background: #f8f8f8;
            position: relative;
            border-left: 3px solid var(--fg);
        }
        .mi-expand-close {
            position: absolute;
            top: 0.5rem; right: 0.5rem;
            background: none;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            cursor: pointer;
            width: 22px; height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--dim);
            transition: all 0.15s;
        }
        .mi-expand-close:hover { border-color: var(--fg); color: var(--fg); background: #fff; }

        .mi-detail-body {
            font-size: 0.68rem;
            color: var(--dim);
            line-height: 1.55;
            margin-bottom: 0.65rem;
            padding-bottom: 0.65rem;
            border-bottom: 1px solid var(--border);
        }
        .mi-detail-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.4rem;
            margin-bottom: 0.6rem;
        }
        .mi-metric {
            padding: 0.4rem 0.5rem;
            border: 1px solid var(--border);
            background: #fff;
        }
        .mi-metric-label {
            font-size: 0.5rem;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin-bottom: 0.15rem;
        }
        .mi-metric-val {
            font-size: 0.7rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        .mi-impact-track {
            height: 3px;
            background: var(--border);
            margin-top: 0.25rem;
        }
        .mi-impact-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        .mi-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            font-size: 0.65rem;
            border-bottom: 1px solid #eee;
        }
        .mi-detail-row:last-child { border-bottom: none; }
        .mi-detail-row-label {
            color: var(--dim);
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .mi-asset-tag {
            padding: 0.1rem 0.35rem;
            font-size: 0.5rem;
            border: 1px solid var(--border);
            text-transform: uppercase;
            font-family: var(--font-mono);
            font-weight: 500;
        }
        .mi-read-more {
            display: inline-block;
            font-size: 0.58rem;
            color: var(--dim);
            text-decoration: none;
            border-bottom: 1px solid var(--border);
            margin-top: 0.4rem;
            transition: color 0.15s, border-color 0.15s;
        }
        .mi-read-more:hover { color: var(--fg); border-color: var(--fg); }

        /* Sentiment Badges */
        .mi-sent-badges { display: flex; gap: 0; border-bottom: 1px solid var(--border); }
        .mi-sent-badge { flex: 1; padding: 0.35rem 0.4rem; text-align: center; border-right: 1px solid var(--border); }
        .mi-sent-badge:last-child { border-right: none; }
        .mi-sent-badge-src { font-size: 0.45rem; text-transform: uppercase; color: var(--dim); font-weight: 600; letter-spacing: 0.04em; }
        .mi-sent-badge-val { font-size: 0.7rem; font-weight: 700; font-family: var(--font-mono); margin-top: 1px; }
        .mi-sent-badge-label { font-size: 0.42rem; font-weight: 500; margin-top: 1px; }

        /* Sparkline */
        .mi-sparkline { border-bottom: 1px solid var(--border); padding: 0.3rem 0.75rem; height: 38px; }
        .mi-sparkline svg { width: 100%; height: 100%; }

        /* Feed Tabs */
        .mi-tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); }
        .mi-tab { flex: 1; padding: 0.35rem 0; text-align: center; font-size: 0.55rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--dim); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: 1px solid var(--border); font-family: var(--font-mono); }
        .mi-tab:last-child { border-right: none; }
        .mi-tab:hover { color: var(--fg); background: #f8f8f8; }
        .mi-tab.active { color: var(--fg); border-bottom-color: var(--fg); }
        .mi-social-item { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--border); }
        .mi-social-head { display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.2rem; }
        .mi-social-handle { font-size: 0.6rem; font-weight: 600; }
        .mi-social-platform { font-size: 0.45rem; text-transform: uppercase; padding: 0.08rem 0.25rem; font-weight: 700; letter-spacing: 0.04em; color: #fff; }
        .mi-social-platform.twitter { background: #1da1f2; }
        .mi-social-platform.discord { background: #5865f2; }
        .mi-social-platform.telegram { background: #0088cc; }
        .mi-social-time { font-size: 0.5rem; color: var(--dim); font-family: var(--font-mono); margin-left: auto; }
        .mi-social-text { font-size: 0.65rem; line-height: 1.4; margin-bottom: 0.25rem; }
        .mi-social-foot { display: flex; align-items: center; gap: 0.4rem; }
        .mi-social-stat { font-size: 0.5rem; color: var(--dim); font-family: var(--font-mono); }

        /* Modal / Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg);
            border: 1px solid var(--border);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: #f5f5f5;
        }

        .modal-title {
            font-size: 0.9rem;
            text-transform: capitalize;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--dim);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--fg);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Trade Detail Modal */
        .trade-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section-title {
            font-size: 0.7rem;
            text-transform: capitalize;
            color: var(--dim);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.8rem;
        }

        .detail-label {
            color: var(--dim);
        }

        /* Consensus Voting */
        .consensus-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .consensus-vote {
            padding: 0.75rem;
            border: 1px solid var(--border);
            text-align: center;
            font-size: 0.7rem;
        }

        .consensus-vote.approve {
            border-color: var(--green);
            color: var(--green);
        }

        .consensus-vote.reject {
            border-color: var(--red);
            color: var(--red);
        }

        .vote-agent {
            font-size: 0.6rem;
            color: var(--dim);
            margin-top: 0.25rem;
        }

        /* Regime Indicator */
        .regime-indicator {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: #f5f5f5;
        }

        .regime-label {
            font-size: 0.65rem;
            color: var(--dim);
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .regime-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.5rem;
        }

        .regime-value {
            font-size: 1.2rem;
            font-family: var(--font-main);
            transition: color 0.5s;
        }

        .regime-confidence {
            font-size: 0.65rem;
            font-family: var(--font-mono);
            transition: color 0.5s;
        }

        .regime-bar {
            display: flex;
            height: 4px;
            background: #e8e8e8;
            gap: 2px;
        }

        .regime-segment {
            flex: 1;
            background: var(--border);
            transition: background 0.5s;
        }

        .regime-segment.active {
            background: var(--fg);
        }

        .regime-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.55rem;
            color: var(--dim);
            margin-top: 0.25rem;
        }

        .regime-gauge-wrap { display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 0.5rem 0 0; }
        .regime-gauge-svg { width: 80px; height: 48px; }
        .regime-gauge-text { font-size: 1.4rem; font-weight: 700; font-family: var(--font-mono); transition: color 0.5s; }
        .regime-gauge-label { font-size: 0.5rem; color: var(--dim); text-transform: uppercase; }
        .regime-probs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0; border-top: 1px solid var(--border); margin-top: 0.5rem; }
        .regime-prob-item { text-align: center; padding: 0.3rem 0.15rem; }
        .regime-prob-name { font-size: 0.45rem; text-transform: uppercase; color: var(--dim); margin-bottom: 2px; }
        .regime-prob-bar { height: 3px; background: #e8e8e8; margin-bottom: 2px; }
        .regime-prob-fill { height: 100%; transition: width 0.6s, background 0.5s; }
        .regime-prob-val { font-size: 0.5rem; font-family: var(--font-mono); font-weight: 600; }

        /* Data Sources Status Panel */
        .ds-panel { border-bottom: 1px solid var(--border); }
        .ds-panel-header { padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.65rem; border-bottom: 1px solid var(--border); background: #f5f5f5; }
        .ds-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; }
        .ds-item { padding: 0.5rem 0.6rem; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); cursor: default; transition: background 0.2s; }
        .ds-item:nth-child(3n) { border-right: none; }
        .ds-item:hover { background: #f8f8f8; }
        .ds-name { font-size: 0.55rem; font-weight: 600; text-transform: uppercase; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; }
        .ds-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .ds-dot.online { background: var(--green); }
        .ds-dot.degraded { background: #cc8800; }
        .ds-dot.offline { background: var(--red); }
        .ds-meta { font-size: 0.5rem; color: var(--dim); line-height: 1.5; }
        .ds-latency { font-size: 0.55rem; font-weight: 600; }
        .ds-freshness { font-size: 0.45rem; padding: 1px 4px; border: 1px solid; display: inline-block; margin-top: 2px; }
        .ds-freshness.fresh { border-color: var(--green); color: var(--green); }
        .ds-freshness.stale { border-color: #cc8800; color: #cc8800; }
        .ds-freshness.dead { border-color: var(--red); color: var(--red); }
        .ds-macro { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0; border-top: 1px solid var(--border); }
        .ds-macro-item { padding: 0.5rem 0.6rem; border-right: 1px solid var(--border); text-align: center; }
        .ds-macro-item:nth-child(2n) { border-right: none; }
        .ds-macro-label { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 2px; }
        .ds-macro-value { font-size: 0.8rem; font-weight: 600; }

        /* Buttons */
        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--fg);
            padding: 0.5rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: capitalize;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--fg);
            color: var(--bg);
        }

        .btn-primary {
            border-color: var(--fg);
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.6rem;
        }

        /* Footer */
        footer {
            border-top: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            color: var(--dim);
            font-size: 0.6rem;
        }

        /* Trade Mode Selector */
        .mode-selector {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .mode-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid var(--border);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-option:hover, .mode-option.active {
            border-color: var(--fg);
            background: #f0f0f0;
        }

        .mode-radio {
            width: 12px;
            height: 12px;
            border: 1px solid var(--dim);
            border-radius: 50%;
            margin-right: 0.75rem;
            position: relative;
        }

        .mode-option.active .mode-radio::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 6px;
            height: 6px;
            background: var(--fg);
            border-radius: 50%;
        }

        .mode-name {
            font-size: 0.8rem;
            text-transform: capitalize;
        }

        .mode-desc {
            font-size: 0.65rem;
            color: var(--dim);
            margin-top: 0.25rem;
        }

        /* Strategy Control Panel */
        .strat-panel { border-bottom: 1px solid var(--border); }
        .strat-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .strat-tab { flex: 1; padding: 0.6rem; text-align: center; font-size: 0.6rem; text-transform: uppercase; font-weight: 600; cursor: pointer; border-right: 1px solid var(--border); transition: background 0.2s; letter-spacing: 0.5px; }
        .strat-tab:last-child { border-right: none; }
        .strat-tab:hover { background: #f5f5f5; }
        .strat-tab.active { background: var(--fg); color: var(--bg); }
        .strat-tab .strat-tab-pct { font-size: 0.5rem; color: var(--dim); display: block; margin-top: 2px; font-weight: 400; }
        .strat-tab.active .strat-tab-pct { color: #999; }
        .strat-body { display: none; }
        .strat-body.active { display: block; }
        .strat-alloc { padding: 0.75rem 1rem; border-bottom: 1px solid #eee; }
        .strat-alloc-label { font-size: 0.55rem; text-transform: uppercase; color: var(--dim); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .strat-alloc-bar { height: 6px; background: #eee; position: relative; }
        .strat-alloc-fill { height: 100%; background: var(--fg); transition: width 0.4s ease; }
        .strat-params { padding: 0; }
        .strat-param-row { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; font-size: 0.65rem; }
        .strat-param-row:last-child { border-bottom: none; }
        .strat-param-key { color: var(--dim); }
        .strat-param-val { font-weight: 600; font-family: var(--font-mono); }
        .strat-status-row { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 1rem; border-top: 1px solid var(--border); background: #fafafa; }
        .strat-status-badge { font-size: 0.55rem; padding: 2px 8px; border: 1px solid; text-transform: uppercase; font-weight: 600; }
        .strat-status-badge.running { border-color: var(--green); color: var(--green); }
        .strat-status-badge.paused { border-color: #cc8800; color: #cc8800; }
        .strat-status-badge.stopped { border-color: var(--red); color: var(--red); }
        .strat-toggle { width: 32px; height: 16px; background: #ccc; border-radius: 8px; position: relative; cursor: pointer; transition: background 0.3s; }
        .strat-toggle.on { background: var(--green); }
        .strat-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .strat-toggle.on::after { transform: translateX(16px); }
        .strat-metrics { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #eee; }
        .strat-metric { padding: 0.5rem 1rem; border-right: 1px solid #eee; border-bottom: 1px solid #eee; }
        .strat-metric:nth-child(2n) { border-right: none; }
        .strat-metric-label { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 2px; }
        .strat-metric-value { font-size: 0.75rem; font-weight: 600; font-family: var(--font-mono); }
        .strat-criteria { padding: 0.5rem 1rem; border-top: 1px solid #eee; }
        .strat-criteria-title { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 4px; font-weight: 600; }
        .strat-criteria-item { font-size: 0.6rem; color: var(--dim); line-height: 1.7; padding-left: 0.75rem; position: relative; }
        .strat-criteria-item::before { content: '•'; position: absolute; left: 0; }

        /* TX Matrix Panel Styles */
        .tx-matrix-panel {
            border-bottom: 1px solid var(--border);
        }

        .tx-matrix-header {
            display: grid;
            grid-template-columns: 36px 1fr 36px;
            border-bottom: 1px solid var(--border);
            height: 22px;
            align-items: center;
            text-align: center;
            color: var(--dim);
            font-size: 0.6rem;
            text-transform: uppercase;
            background: var(--bg);
        }

        .tx-col-idx, .tx-col-status {
            border-right: 1px solid var(--border);
        }

        .tx-col-status {
            border-right: none;
            border-left: 1px solid var(--border);
        }

        .tx-matrix-grid {
            position: relative;
            max-height: 180px;
            overflow: hidden;
        }

        .tx-matrix-row {
            display: grid;
            grid-template-columns: 36px 1fr 36px;
            height: 22px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
        }

        .tx-matrix-row:last-child {
            border-bottom: none;
        }

        .tx-row-idx {
            color: var(--dim);
            text-align: center;
            border-right: 1px solid var(--border);
            height: 100%;
            line-height: 22px;
        }

        .tx-row-data {
            padding-left: 8px;
            font-family: var(--font-mono);
            letter-spacing: 0.5px;
            color: var(--dim);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tx-row-data.active {
            color: var(--fg);
        }

        .tx-row-status {
            color: var(--dim);
            text-align: center;
            border-left: 1px solid var(--border);
            height: 100%;
            line-height: 22px;
            font-size: 0.55rem;
        }

        .tx-row-status.confirmed {
            color: var(--green);
        }

        .tx-scanner-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 22px;
            background: rgba(0, 0, 0, 0.05);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            pointer-events: none;
            transition: top 0.1s steps(1);
        }

        /* Hyperparameter Section */
        .hyperparam-section {
            border-bottom: 1px solid var(--border);
        }

        .section-label-widget {
            padding: 8px 12px;
            color: var(--fg);
            text-transform: capitalize;
            font-size: 0.7rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg);
        }

        .wave-selector {
            display: flex;
            gap: 8px;
        }

        .wave-opt {
            width: 28px;
            height: 16px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wave-opt svg {
            width: 16px;
            height: 10px;
            stroke: var(--dim);
            stroke-width: 1.5;
            fill: none;
        }

        .wave-opt:hover, .wave-opt.active {
            border-color: var(--fg);
        }

        .wave-opt:hover svg, .wave-opt.active svg {
            stroke: var(--fg);
        }

        .param-grid-widget {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .param-cell-widget {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .param-cell-widget:nth-child(even) {
            border-right: none;
        }

        .param-cell-widget:nth-child(n+3) {
            border-bottom: none;
        }

        .param-header-widget {
            display: flex;
            justify-content: space-between;
            color: var(--dim);
            text-transform: uppercase;
            font-size: 0.65rem;
        }

        .param-val-widget {
            color: var(--fg);
        }

        .slider-container-widget {
            position: relative;
            height: 14px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .slider-track-widget {
            width: 100%;
            height: 1px;
            background: var(--dim);
            position: relative;
        }

        .slider-thumb-widget {
            width: 8px;
            height: 8px;
            border: 1px solid var(--fg);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg);
        }

        /* Performance Graphs */
        .perf-section {
            border-bottom: 1px solid var(--border);
        }

        .graph-area-widget {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .graph-box-widget {
            position: relative;
            height: 70px;
            border-right: 1px solid var(--border);
            background: #fafafa;
        }

        .graph-box-widget:last-child {
            border-right: none;
        }

        .graph-label-widget {
            position: absolute;
            top: 4px;
            left: 6px;
            font-size: 0.55rem;
            color: var(--dim);
            text-transform: uppercase;
            z-index: 1;
        }

        .graph-box-widget canvas {
            width: 100%;
            height: 100%;
        }

        /* Wallet Status Section */
        .ws-section {
            border-bottom: 1px solid var(--border);
        }

        .ws-pnl-banner {
            display: flex;
            align-items: baseline;
            gap: 0.75rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .ws-pnl-value {
            font-family: var(--font-main);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .ws-pnl-pct {
            font-size: 0.8rem;
        }

        .ws-holdings-row {
            display: grid;
            grid-template-columns: 1fr 90px 90px 80px;
            padding: 0.6rem 1rem;
            font-size: 0.75rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .ws-holdings-row.ws-holdings-header {
            background: #f5f5f5;
            color: var(--dim);
            font-size: 0.65rem;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
        }

        .ws-token-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ws-token-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
        }

        .ws-token-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ws-token-sym {
            font-weight: 600;
            text-transform: uppercase;
        }

        .ws-time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        .ws-time-cell {
            padding: 0.75rem 1rem;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .ws-time-cell:last-child {
            border-right: none;
        }

        .ws-time-label {
            font-size: 0.6rem;
            color: var(--dim);
            text-transform: uppercase;
        }

        .ws-time-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .ws-time-pct {
            font-size: 0.6rem;
        }

        /* Wallet Connection */
        .wallet-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .wallet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 1px solid var(--border);
        }

        .wallet-option:last-child {
            border-bottom: none;
        }

        .wallet-option:hover {
            background: #f5f5f5;
        }

        .wallet-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #f0f0f0;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }

        .wallet-icon img {
            width: 24px;
            height: 24px;
        }

        .wallet-icon .wi-letter {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dim);
        }

        .wallet-option:hover .wallet-icon {
            border-color: var(--fg);
        }

        .wallet-info {
            flex: 1;
            min-width: 0;
        }

        .wallet-name {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .wallet-detect {
            font-size: 0.6rem;
            color: var(--dim);
            margin-top: 2px;
        }

        .wallet-arrow {
            font-size: 0.75rem;
            color: var(--dim);
            transition: transform 0.15s;
        }

        .wallet-option:hover .wallet-arrow {
            transform: translateX(2px);
            color: var(--fg);
        }

        /* Connected wallet in header */
        .wallet-connected {
            position: relative;
        }

        .wallet-addr {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .wallet-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            min-width: 180px;
            z-index: 60;
            display: none;
        }

        .wallet-dropdown.open {
            display: block;
        }

        .wallet-dropdown-item {
            padding: 0.75rem 1rem;
            font-size: 0.7rem;
            text-transform: capitalize;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wallet-dropdown-item:hover {
            background: #f0f0f0;
        }

        .wallet-dropdown-item:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .wallet-dropdown-item.disconnect {
            color: var(--red);
        }

        .wallet-dropdown-item .dd-icon {
            font-size: 0.6rem;
            color: var(--dim);
            width: 14px;
            text-align: center;
        }

        .wallet-dropdown-item.disconnect .dd-icon {
            color: var(--red);
        }

        .wallet-option.connecting {
            pointer-events: none;
            opacity: 0.5;
        }

        .wallet-option.connecting .wallet-detect,
        .wallet-option.connecting .wallet-arrow {
            display: none;
        }

        .wallet-spinner {
            display: none;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--fg);
            border-radius: 50%;
            animation: wspin 0.6s linear infinite;
            flex-shrink: 0;
        }

        .wallet-option.connecting .wallet-spinner {
            display: block;
        }

        @keyframes wspin {
            to { transform: rotate(360deg); }
        }

        .wallet-detect.detected {
            color: var(--green);
            font-weight: 500;
        }

        .wallet-detect.detected::before {
            content: '●';
            margin-right: 4px;
            font-size: 0.5rem;
            vertical-align: middle;
        }

        .wallet-detect.not-installed {
            color: var(--dim);
        }

        .wallet-option.not-available {
            opacity: 0.35;
            cursor: not-allowed;
        }

        .wallet-option.not-available:hover {
            background: transparent;
        }

        .wallet-option.not-available .wallet-arrow {
            display: none;
        }

        .wallet-error-toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--fg);
            color: var(--bg);
            padding: 0.75rem 1.5rem;
            font-size: 0.75rem;
            font-family: var(--font-main);
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            max-width: 400px;
            text-align: center;
        }

        .wallet-error-toast.visible {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            .panel {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }

        @media (max-width: 768px) {
            header {
                grid-template-columns: 1fr auto;
            }
            .nav-item:not(:last-child) {
                display: none;
            }
            .portfolio-value {
                font-size: 2rem;
            }
            .trade-detail-grid {
                grid-template-columns: 1fr;
            }
            .trade-expand .consensus-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .mi-detail-metrics {
                grid-template-columns: 1fr;
            }
        }
        /* P&L Chart */
        .pnl-chart-section {
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .pnl-chart-section .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .pnl-chart-container {
            padding: 0.5rem;
        }

        .pnl-chart-container svg {
            font-family: var(--font-mono);
            display: block;
            width: 100%;
            height: auto;
        }

        .pnl-chart-container svg text {
            fill: var(--dim);
            font-size: 9px;
        }

        .pnl-chart-filters {
            display: flex;
            gap: 0.25rem;
            padding: 0 1rem 0.5rem;
        }

        .pnl-chart-filters .btn {
            font-size: 0.6rem;
            padding: 2px 8px;
        }

        .pnl-chart-filters .btn.active {
            background: var(--fg);
            color: var(--bg);
        }

        /* Agent Performance Grouped Bar Chart */
        .agent-perf-section {
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .agent-perf-section .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .agent-perf-container {
            padding: 0.5rem;
        }

        .agent-perf-container svg {
            font-family: var(--font-mono);
            display: block;
            width: 100%;
            height: auto;
        }

        .agent-perf-container svg text {
            fill: var(--dim);
            font-size: 9px;
        }

        .agent-perf-tooltip {
            position: fixed;
            pointer-events: none;
            background: var(--fg);
            color: var(--bg);
            padding: 6px 10px;
            font-size: 0.7rem;
            font-family: var(--font-mono);
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 1000;
            border-radius: 2px;
        }

        /* Active Positions Grid */
        .positions-section {
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .positions-section .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .positions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 6px;
            padding: 0.75rem;
        }

        .pos-card {
            border: 1px solid var(--border);
            padding: 0.6rem;
            font-size: 0.7rem;
            position: relative;
            cursor: default;
            transition: opacity 0.35s ease, transform 0.35s ease;
        }

        .pos-card.removing {
            opacity: 0;
            transform: scale(0.8);
        }

        .pos-card-pair {
            font-weight: 600;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .pos-card-pair img {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .pos-card-meta {
            color: var(--dim);
            font-size: 0.6rem;
            margin-bottom: 0.25rem;
        }

        .pos-card-pnl {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 600;
        }

        .pos-card-close {
            position: absolute;
            top: 3px;
            right: 3px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            color: var(--dim);
            line-height: 1;
            padding: 0 2px;
        }

        .pos-card-close:hover {
            color: var(--red);
        }

        .positions-actions {
            padding: 0 0.75rem 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        /* Execution Monitoring Dashboard */
        .em-section { border-bottom: 1px solid var(--border); padding: 0; }
        .em-section .panel-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }

        .em-pipeline { display: grid; grid-template-columns: repeat(4, 1fr); border-bottom: 1px solid var(--border); }
        .em-step { padding: 0.75rem; border-right: 1px solid var(--border); position: relative; }
        .em-step:last-child { border-right: none; }
        .em-step-idx { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 0.25rem; }
        .em-step-name { font-size: 0.7rem; font-weight: 600; margin-bottom: 0.2rem; }
        .em-step-status { font-size: 0.55rem; }
        .em-step-bar { height: 3px; background: #e8e8e8; margin-top: 0.4rem; }
        .em-step-bar-fill { height: 100%; transition: width 0.6s ease; }
        .em-step.done .em-step-bar-fill { background: var(--green); width: 100%; }
        .em-step.active .em-step-bar-fill { background: var(--fg); animation: em-pulse 1.2s ease infinite; }
        .em-step.pending .em-step-bar-fill { background: #e8e8e8; width: 0%; }
        .em-step.failed .em-step-bar-fill { background: var(--red); width: 100%; }
        @keyframes em-pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

        .em-guardian { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border); }
        .em-guardian-checks { border-right: 1px solid var(--border); padding: 0.75rem; }
        .em-guardian-result { padding: 0.75rem; }
        .em-check-row { display: flex; align-items: center; gap: 8px; padding: 0.3rem 0; font-size: 0.65rem; }
        .em-check-icon { width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; }
        .em-check-icon.pass { color: var(--green); }
        .em-check-icon.fail { color: var(--red); }
        .em-check-icon.wait { color: var(--dim); }

        .em-tx-metrics { display: grid; grid-template-columns: repeat(4, 1fr); border-bottom: 1px solid var(--border); }
        .em-tx-metric { padding: 0.6rem 0.75rem; border-right: 1px solid var(--border); text-align: center; }
        .em-tx-metric:last-child { border-right: none; }
        .em-tx-label { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 0.15rem; }
        .em-tx-value { font-size: 0.85rem; font-weight: 600; font-family: var(--font-main); }
        .em-tx-sub { font-size: 0.5rem; color: var(--dim); margin-top: 0.1rem; }

        .em-slippage-bar { display: flex; align-items: center; gap: 8px; padding: 0.5rem 0; }
        .em-slip-track { flex: 1; height: 6px; background: #e8e8e8; position: relative; }
        .em-slip-expected { position: absolute; height: 100%; background: var(--fg); left: 0; }
        .em-slip-actual { position: absolute; height: 100%; background: var(--red); left: 0; opacity: 0.6; }
        .em-slip-label { font-size: 0.55rem; color: var(--dim); min-width: 50px; }

        .em-retry-timeline { display: flex; align-items: center; gap: 4px; padding: 0.5rem 0; }
        .em-retry-dot { width: 8px; height: 8px; border-radius: 50%; border: 1px solid var(--border); }
        .em-retry-dot.success { background: var(--green); border-color: var(--green); }
        .em-retry-dot.failed { background: var(--red); border-color: var(--red); }
        .em-retry-dot.pending { background: #e8e8e8; }

        .em-confirm-stepper { display: flex; align-items: center; gap: 0; padding: 0.5rem 0; }
        .em-conf-step { flex: 1; text-align: center; padding: 0.3rem; font-size: 0.55rem; border: 1px solid var(--border); border-right: none; }
        .em-conf-step:last-child { border-right: 1px solid var(--border); }
        .em-conf-step.done { background: var(--fg); color: var(--bg); }
        .em-conf-step.active { background: #f0f0f0; font-weight: 600; }

        @media (max-width: 768px) {
            .em-pipeline { grid-template-columns: repeat(2, 1fr); }
            .em-guardian { grid-template-columns: 1fr; }
            .em-guardian-checks { border-right: none; border-bottom: 1px solid var(--border); }
            .em-tx-metrics { grid-template-columns: repeat(2, 1fr); }
        }

        /* Guardian Risk Dashboard */
        .guardian-section { border-bottom: 1px solid var(--border); padding: 0; }
        .guardian-section .panel-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }

        .guardian-score-banner { display: flex; align-items: center; gap: 1.5rem; padding: 1rem; border-bottom: 1px solid var(--border); }
        .guardian-score-ring { width: 64px; height: 64px; border-radius: 50%; border: 3px solid var(--border); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .guardian-score-ring .score-val { font-family: var(--font-main); font-size: 1.4rem; font-weight: 600; }
        .guardian-score-info { flex: 1; min-width: 0; }
        .guardian-score-decision { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.2rem; }
        .guardian-score-meta { font-size: 0.6rem; color: var(--dim); }

        .guardian-assess-bar { display: flex; gap: 0.5rem; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); align-items: center; }
        .guardian-assess-bar input, .guardian-assess-bar select {
            font-family: var(--font-mono); font-size: 0.7rem; padding: 4px 8px;
            border: 1px solid var(--border); background: var(--bg); color: var(--fg);
        }
        .guardian-assess-bar .btn { font-size: 0.65rem; padding: 4px 12px; }

        .guardian-comp { display: flex; align-items: center; gap: 8px; padding: 0.35rem 1rem; font-size: 0.65rem; }
        .guardian-comp-name { width: 60px; text-transform: uppercase; color: var(--dim); font-size: 0.55rem; }
        .guardian-comp-bar { flex: 1; height: 4px; background: #e8e8e8; position: relative; }
        .guardian-comp-fill { height: 100%; transition: width 0.4s; }
        .guardian-comp-val { width: 32px; text-align: right; font-weight: 600; font-size: 0.6rem; }

        .guardian-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); border-bottom: 1px solid var(--border); }
        .guardian-stat { padding: 0.5rem 0.75rem; border-right: 1px solid var(--border); }
        .guardian-stat:nth-child(3n) { border-right: none; }
        .guardian-stat-label { font-size: 0.5rem; text-transform: uppercase; color: var(--dim); margin-bottom: 0.15rem; }
        .guardian-stat-value { font-size: 0.75rem; font-weight: 600; font-family: var(--font-main); }

        .guardian-breaker { display: flex; align-items: center; gap: 8px; padding: 0.35rem 1rem; font-size: 0.65rem; }
        .guardian-breaker-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
        .guardian-breaker-name { flex: 1; text-transform: uppercase; font-size: 0.6rem; }
        .guardian-breaker-status { font-weight: 600; font-size: 0.6rem; }

        .guardian-debate-item { display: flex; align-items: center; gap: 8px; padding: 0.35rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.6rem; }
        .guardian-debate-item:last-child { border-bottom: none; }
        .guardian-debate-decision { font-weight: 600; width: 60px; }
        .guardian-debate-meta { color: var(--dim); flex: 1; }

        .guardian-error { padding: 0.5rem 1rem; background: #fff0f0; color: var(--red); font-size: 0.6rem; display: none; border-bottom: 1px solid var(--border); }

        @media (max-width: 768px) {
            .guardian-stats-grid { grid-template-columns: repeat(2, 1fr); }
            .guardian-score-banner { flex-direction: column; text-align: center; }
        }

        /* TradingView Chart */
        .tv-chart-section {
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .tv-chart-section .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .tv-chart-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .tv-search-wrap {
            position: relative;
            flex: 1;
            min-width: 160px;
            max-width: 280px;
        }

        .tv-search-wrap input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--fg);
            font-family: var(--font-mono);
            font-size: 0.7rem;
            outline: none;
            box-sizing: border-box;
        }

        .tv-search-wrap input:focus {
            border-color: var(--fg);
        }

        .tv-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .tv-search-results.open {
            display: block;
        }

        .tv-search-item {
            padding: 6px 8px;
            font-size: 0.65rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            font-family: var(--font-mono);
        }

        .tv-search-item:last-child {
            border-bottom: none;
        }

        .tv-search-item:hover {
            background: #f5f5f5;
        }

        .tv-search-item .pair-name {
            font-weight: 600;
            font-size: 0.7rem;
        }

        .tv-search-item .pair-meta {
            color: var(--dim);
            font-size: 0.6rem;
        }

        .tv-mode-buttons {
            display: flex;
            gap: 0.25rem;
            margin-right: 0.5rem;
            border-right: 1px solid var(--border);
            padding-right: 0.5rem;
        }

        .tv-mode-buttons .btn.active {
            background: var(--fg);
            color: var(--bg);
        }

        .tv-tf-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .tv-tf-buttons .btn.active {
            background: var(--fg);
            color: var(--bg);
        }

        .tv-pair-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: auto;
        }

        .tv-chart-container {
            height: 380px;
            position: relative;
        }

        .tv-chart-container .tv-loading {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--dim);
            font-family: var(--font-mono);
        }

        /* API Usage Heatmap */
        .api-usage-section {
            border-top: 1px solid var(--border);
            padding: 0;
        }

        .api-usage-section .panel-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
        }

        .api-heatmap-container {
            padding: 0.5rem;
            overflow-x: auto;
        }

        .api-heatmap-container svg {
            font-family: var(--font-mono);
            display: block;
            width: 100%;
            height: auto;
        }

        .api-heatmap-container svg text {
            fill: var(--dim);
            font-size: 9px;
        }

        .api-heatmap-tooltip {
            position: fixed;
            padding: 6px 10px;
            background: var(--fg);
            color: var(--bg);
            font-size: 0.7rem;
            font-family: var(--font-mono);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 1000;
            border-radius: 2px;
        }

        .api-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.6rem;
            color: var(--dim);
            padding: 0.25rem 1rem 0.5rem;
        }

        .api-legend-bar {
            width: 120px;
            height: 8px;
            border: 1px solid var(--border);
        }


    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-stat@latest/dist/ecStat.min.js"></script>
</head>
<body>
    <div class="scanline"></div>

    <div class="container">
        <!-- Price Ticker (live from CoinGecko) -->
        <div class="ticker">
            <div class="ticker-content" id="tickerContent">
                <span class="ticker-item">Loading live prices...</span>
            </div>
        </div>

        <!-- Header -->
        <header>
            <div class="logo">
                <img src="assets/logos/cortex-logo-dark.png" alt="CORTEX" class="logo-img">
                <span>v.0.1.0</span>
            </div>
            <div class="nav-item active">Dashboard</div>
            <a class="nav-item" href="market.html">Market Data</a>
            <a class="nav-item" href="history.html">History</a>
            <a class="nav-item" href="cerebral.html">Cerebral</a>
            <a class="nav-item" href="tokenomics.html">Tokenomics</a>
            <div class="nav-item wallet-connected" id="walletNav" onclick="handleWalletClick()">
                <span id="walletLabel">Connect</span>
                <div class="wallet-dropdown" id="walletDropdown">
                    <div class="wallet-dropdown-item" onclick="copyAddress(event)">
                        <span class="dd-icon">⎘</span> Copy Address
                    </div>
                    <div class="wallet-dropdown-item" onclick="viewOnSolscan(event)">
                        <span class="dd-icon">↗</span> View on Solscan
                    </div>
                    <div class="wallet-dropdown-item disconnect" onclick="disconnectWallet(event)">
                        <span class="dd-icon">⏻</span> Disconnect
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="dashboard">
            <!-- Left Panel: Solana TX Feed + Agent Status -->
            <div class="panel">
                <div class="panel-header">
                    <span>Agent Orchestration</span>
                    <span class="text-green">● LIVE</span>
                </div>

                <!-- Regime Indicator (HMM-driven) -->
                <div class="regime-indicator">
                    <div class="regime-label">Current Market Regime</div>
                    <div class="regime-header">
                        <div class="regime-value" id="regimeValue">DETECTING...</div>
                        <div class="regime-confidence" id="regimeConfidence">—</div>
                    </div>
                    <div class="regime-bar">
                        <div class="regime-segment"></div>
                        <div class="regime-segment"></div>
                        <div class="regime-segment"></div>
                        <div class="regime-segment"></div>
                        <div class="regime-segment"></div>
                    </div>
                    <div class="regime-labels">
                        <span>Accum</span>
                        <span>Markup</span>
                        <span>Distrib</span>
                        <span>Markdown</span>
                        <span>Crisis</span>
                    </div>
                    <div class="regime-gauge-wrap">
                        <svg class="regime-gauge-svg" id="regimeGauge" viewBox="0 0 80 48"></svg>
                        <div>
                            <div class="regime-gauge-text" id="regimeGaugeVal">—</div>
                            <div class="regime-gauge-label">Confidence</div>
                        </div>
                    </div>
                    <div class="regime-probs" id="regimeProbs"></div>
                </div>

                <!-- Data Sources Status Panel -->
                <div class="ds-panel">
                    <div class="ds-panel-header">
                        <span>Data Sources</span>
                        <span class="text-dim" id="dsStatusSummary">9 Sources · --</span>
                    </div>
                    <div class="ds-grid" id="dsGrid"></div>
                    <div class="ds-macro" id="dsMacro"></div>
                </div>

                <!-- Solana TX Matrix Panel -->
                <div class="tx-matrix-panel">
                    <div class="tx-matrix-header">
                        <div class="tx-col-idx">IDX</div>
                        <div class="tx-col-data">TX SIGNATURE</div>
                        <div class="tx-col-status">ST</div>
                    </div>
                    <div class="tx-matrix-grid" id="txMatrixContainer">
                        <div class="tx-scanner-bar" id="txScanner"></div>
                    </div>
                </div>

                <!-- Hyperparameters Section -->
                <div class="hyperparam-section">
                    <div class="section-label-widget">
                        <span>Hyperparameters</span>
                        <div class="wave-selector">
                            <div class="wave-opt active" onclick="setWave(this)">
                                <svg viewBox="0 0 20 12"><path d="M0 12 C5 12, 5 0, 10 0 S 15 12, 20 12"></path></svg>
                            </div>
                            <div class="wave-opt" onclick="setWave(this)">
                                <svg viewBox="0 0 20 12"><polyline points="0,12 5,12 5,0 15,0 15,12 20,12"></polyline></svg>
                            </div>
                            <div class="wave-opt" onclick="setWave(this)">
                                <svg viewBox="0 0 20 12"><polyline points="0,12 10,0 20,12"></polyline></svg>
                            </div>
                        </div>
                    </div>

                    <div class="param-grid-widget">
                        <div class="param-cell-widget">
                            <div class="param-header-widget">
                                <span>L_RATE</span>
                                <span class="param-val-widget" id="val1">0.045</span>
                            </div>
                            <div class="slider-container-widget" onmousedown="startDrag(event, 'val1', 0.001, 0.1, 3)">
                                <div class="slider-track-widget"></div>
                                <div class="slider-thumb-widget" style="left: 45%;"></div>
                            </div>
                        </div>
                        <div class="param-cell-widget">
                            <div class="param-header-widget">
                                <span>DECAY</span>
                                <span class="param-val-widget" id="val2">0.92</span>
                            </div>
                            <div class="slider-container-widget" onmousedown="startDrag(event, 'val2', 0.1, 1.0, 2)">
                                <div class="slider-track-widget"></div>
                                <div class="slider-thumb-widget" style="left: 92%;"></div>
                            </div>
                        </div>
                        <div class="param-cell-widget">
                            <div class="param-header-widget">
                                <span>MOMTM</span>
                                <span class="param-val-widget" id="val3">128</span>
                            </div>
                            <div class="slider-container-widget" onmousedown="startDrag(event, 'val3', 0, 255, 0)">
                                <div class="slider-track-widget"></div>
                                <div class="slider-thumb-widget" style="left: 50%;"></div>
                            </div>
                        </div>
                        <div class="param-cell-widget">
                            <div class="param-header-widget">
                                <span>BATCH</span>
                                <span class="param-val-widget" id="val4">64</span>
                            </div>
                            <div class="slider-container-widget" onmousedown="startDrag(event, 'val4', 16, 128, 0)">
                                <div class="slider-track-widget"></div>
                                <div class="slider-thumb-widget" style="left: 30%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Graphs -->
                <div class="perf-section">
                    <div class="section-label-widget">
                        <span>Performance Metrics</span>
                        <span class="text-dim">FLT.32</span>
                    </div>
                    <div class="graph-area-widget">
                        <div class="graph-box-widget">
                            <span class="graph-label-widget">LOSS_FUNC</span>
                            <canvas id="canvasLoss"></canvas>
                        </div>
                        <div class="graph-box-widget">
                            <span class="graph-label-widget">ACCURACY</span>
                            <canvas id="canvasAcc"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Trade Mode Selector -->
                <div class="mode-selector">
                    <div class="mode-option active">
                        <div class="mode-radio"></div>
                        <div>
                            <div class="mode-name">Autonomous</div>
                            <div class="mode-desc">Full agent control</div>
                        </div>
                    </div>
                    <div class="mode-option">
                        <div class="mode-radio"></div>
                        <div>
                            <div class="mode-name">Semi-Auto</div>
                            <div class="mode-desc">Approval required</div>
                        </div>
                    </div>
                    <div class="mode-option">
                        <div class="mode-radio"></div>
                        <div>
                            <div class="mode-name">Manual</div>
                            <div class="mode-desc">Signals only</div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Control Panel -->
                <div class="panel-header" style="margin-top:0;">
                    <span>Trading Strategies</span>
                    <span class="text-dim">3 ACTIVE</span>
                </div>
                <div class="strat-panel">
                    <div class="strat-tabs">
                        <div class="strat-tab active" onclick="switchStrategy(0, this)">LP Rebalancing<span class="strat-tab-pct">40%</span></div>
                        <div class="strat-tab" onclick="switchStrategy(1, this)">Arbitrage<span class="strat-tab-pct">30%</span></div>
                        <div class="strat-tab" onclick="switchStrategy(2, this)">Perpetuals<span class="strat-tab-pct">30%</span></div>
                    </div>
                    <div id="stratBody0" class="strat-body active"></div>
                    <div id="stratBody1" class="strat-body"></div>
                    <div id="stratBody2" class="strat-body"></div>
                </div>

                <!-- Agent Cards -->
                <div class="panel-header" style="margin-top:0;">
                    <span>Agent Status</span>
                    <span class="text-dim">5 ACTIVE</span>
                </div>

                <div class="agent-card" data-agent="momentum" onclick="toggleAgentExpand('momentum', this)">
                    <div class="agent-card-header">
                        <span class="agent-name">Momentum Agent</span>
                        <div class="agent-status"></div>
                    </div>
                    <div class="agent-meta">Trend-following · 20-period EMA</div>
                    <div class="agent-metrics">
                        <span class="metric-label">Win Rate</span><span class="metric-value">68.4%</span>
                        <span class="metric-label">Signal</span><span class="metric-value text-green">LONG</span>
                    </div>
                </div>

                <div class="agent-card" data-agent="meanrev" onclick="toggleAgentExpand('meanrev', this)">
                    <div class="agent-card-header">
                        <span class="agent-name">Mean Reversion Agent</span>
                        <div class="agent-status"></div>
                    </div>
                    <div class="agent-meta">Bollinger Bands · Z-Score</div>
                    <div class="agent-metrics">
                        <span class="metric-label">Win Rate</span><span class="metric-value">72.1%</span>
                        <span class="metric-label">Signal</span><span class="metric-value text-red">SHORT</span>
                    </div>
                </div>

                <div class="agent-card" data-agent="sentiment" onclick="toggleAgentExpand('sentiment', this)">
                    <div class="agent-card-header">
                        <span class="agent-name">Sentiment Agent</span>
                        <div class="agent-status"></div>
                    </div>
                    <div class="agent-meta">NLP · Social signals</div>
                    <div class="agent-metrics">
                        <span class="metric-label">Win Rate</span><span class="metric-value">61.8%</span>
                        <span class="metric-label">Signal</span><span class="metric-value text-green">LONG</span>
                    </div>
                </div>

                <div class="agent-card" data-agent="risk" onclick="toggleAgentExpand('risk', this)">
                    <div class="agent-card-header">
                        <span class="agent-name">Risk Agent</span>
                        <div class="agent-status warning"></div>
                    </div>
                    <div class="agent-meta">VaR · Drawdown limits</div>
                    <div class="agent-metrics">
                        <span class="metric-label">Win Rate</span><span class="metric-value">74.2%</span>
                        <span class="metric-label">Signal</span><span class="metric-value text-dim">HEDGE</span>
                    </div>
                </div>

                <div class="agent-card" data-agent="arbitrage" onclick="toggleAgentExpand('arbitrage', this)">
                    <div class="agent-card-header">
                        <span class="agent-name">Arbitrage Agent</span>
                        <div class="agent-status"></div>
                    </div>
                    <div class="agent-meta">Cross-DEX · Latency arb</div>
                    <div class="agent-metrics">
                        <span class="metric-label">Win Rate</span><span class="metric-value">83.6%</span>
                        <span class="metric-label">Signal</span><span class="metric-value text-green">LONG</span>
                    </div>
                </div>
            </div>

            <!-- Center Panel: Portfolio & Trades -->
            <div class="panel">
                <div class="panel-header">
                    <span>Portfolio Overview</span>
                </div>

                <div class="portfolio-summary">
                    <div class="portfolio-value">$47,823.45</div>
                    <div class="portfolio-change positive">+$2,341.12 (+5.14%)</div>
                    <div class="time-filters">
                        <button class="time-filter">24H</button>
                        <button class="time-filter active">7D</button>
                        <button class="time-filter">30D</button>
                        <button class="time-filter">ALL</button>
                    </div>
                </div>

                <!-- Wallet Status: P&L + Holdings + Time Grid -->
                <div class="ws-section" id="walletStatus" style="display:none;">
                    <div class="panel-header">
                        <span>Wallet Status</span>
                        <span class="text-dim" id="wsLiveTag">LOADING...</span>
                    </div>

                    <!-- Total P&L Banner -->
                    <div class="ws-pnl-banner" id="wsPnlBanner">
                        <span class="ws-pnl-value text-dim">—</span>
                    </div>

                    <!-- Token Holdings -->
                    <div class="ws-holdings-row ws-holdings-header">
                        <div>Token</div>
                        <div>Balance</div>
                        <div>USD Value</div>
                        <div>P&L (24h)</div>
                    </div>
                    <div id="wsHoldingsBody"></div>

                    <!-- Time-based P&L Grid -->
                    <div class="panel-header">
                        <span>P&L Breakdown</span>
                    </div>
                    <div class="ws-time-grid" id="wsTimeGrid">
                        <div class="ws-time-cell">
                            <span class="ws-time-label">Today</span>
                            <span class="ws-time-value text-dim" id="wsPnlToday">—</span>
                            <span class="ws-time-pct" id="wsPctToday"></span>
                        </div>
                        <div class="ws-time-cell">
                            <span class="ws-time-label">This Month</span>
                            <span class="ws-time-value text-dim" id="wsPnlMonth">—</span>
                            <span class="ws-time-pct" id="wsPctMonth"></span>
                        </div>
                        <div class="ws-time-cell">
                            <span class="ws-time-label">This Year</span>
                            <span class="ws-time-value text-dim" id="wsPnlYear">—</span>
                            <span class="ws-time-pct" id="wsPctYear"></span>
                        </div>
                        <div class="ws-time-cell">
                            <span class="ws-time-label">All Time</span>
                            <span class="ws-time-value text-dim" id="wsPnlAll">—</span>
                            <span class="ws-time-pct" id="wsPctAll"></span>
                        </div>
                    </div>
                </div>

                <!-- P&L Performance Chart -->
                <div class="pnl-chart-section">
                    <div class="panel-header">
                        <span>P&L Performance</span>
                        <span class="text-dim">Connected Timeline</span>
                    </div>
                    <div class="pnl-chart-filters">
                        <button class="btn btn-sm active" onclick="renderPnlChart('1M', this)">1M</button>
                        <button class="btn btn-sm" onclick="renderPnlChart('3M', this)">3M</button>
                        <button class="btn btn-sm" onclick="renderPnlChart('6M', this)">6M</button>
                        <button class="btn btn-sm" onclick="renderPnlChart('1Y', this)">1Y</button>
                    </div>
                    <div class="pnl-chart-container" id="pnlChart"></div>
                </div>

                <!-- Agent Performance Comparison -->
                <div class="agent-perf-section">
                    <div class="panel-header">
                        <span>Agent Performance Comparison</span>
                        <span class="text-dim">Win Rate by Timeframe</span>
                    </div>
                    <div class="agent-perf-container" id="agentPerfChart"></div>
                </div>

                <!-- Agent Signal Clustering -->
                <div class="agent-perf-section">
                    <div class="panel-header">
                        <span>Agent Signal Clustering</span>
                        <span class="text-dim">K-Means · 6 Clusters</span>
                    </div>
                    <div id="agentClusterChart" style="width:100%;height:280px;"></div>
                </div>

                <!-- Active Positions Grid -->
                <div class="positions-section">
                    <div class="panel-header">
                        <span>Active Positions</span>
                        <span class="text-dim" id="posCount">10 OPEN</span>
                    </div>
                    <div class="positions-grid" id="positionsGrid"></div>
                    <div class="positions-actions">
                        <button class="btn btn-sm" onclick="closeRandomPosition()">Close Position</button>
                        <button class="btn btn-sm" onclick="resetPositions()">Reset All</button>
                    </div>
                </div>

                <!-- Guardian Risk Dashboard (Live API) -->
                <div class="guardian-section" id="guardianDashboard">
                    <div class="panel-header">
                        <span>Guardian Risk Engine</span>
                        <span id="guardianSSEStatus" class="text-dim">CONNECTING...</span>
                    </div>

                    <div class="guardian-error" id="guardianError"></div>

                    <!-- Risk Score Banner -->
                    <div class="guardian-score-banner">
                        <div class="guardian-score-ring">
                            <span class="score-val" id="guardianRiskScore">--</span>
                        </div>
                        <div class="guardian-score-info">
                            <div class="guardian-score-decision" id="guardianApproved">WAITING</div>
                            <div class="guardian-score-meta">
                                Token: <span id="guardianToken">--</span> ·
                                Regime: <span id="guardianRegime">--</span> ·
                                Size: <span id="guardianSize">--</span> ·
                                Confidence: <span id="guardianConfidence">--</span> ·
                                <span id="guardianCache" class="text-dim">--</span>
                            </div>
                            <div class="guardian-score-meta">
                                Vetos: <span id="guardianVetos" style="color:var(--dim)">None</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Assess Bar -->
                    <div class="guardian-assess-bar">
                        <input type="text" id="guardianAssessToken" value="SOL" style="width:60px" placeholder="Token">
                        <input type="number" id="guardianAssessSize" value="10000" style="width:80px" placeholder="Size USD">
                        <select id="guardianAssessDir">
                            <option value="long">Long</option>
                            <option value="short">Short</option>
                        </select>
                        <select id="guardianAssessStrategy">
                            <option value="">(any)</option>
                            <option value="lp">LP</option>
                            <option value="arb">Arb</option>
                            <option value="perp">Perp</option>
                        </select>
                        <button class="btn btn-sm" onclick="runGuardianAssess(document.getElementById('guardianAssessToken').value,parseFloat(document.getElementById('guardianAssessSize').value),document.getElementById('guardianAssessDir').value,document.getElementById('guardianAssessStrategy').value)">Assess</button>
                    </div>

                    <!-- Component Scores -->
                    <div id="guardianComponents" style="padding:0.25rem 0;border-bottom:1px solid var(--border)">
                        <div style="padding:0.5rem 1rem;color:var(--dim);font-size:0.6rem">Run an assessment to see component scores</div>
                    </div>

                    <!-- Kelly Stats -->
                    <div style="font-size:0.5rem;text-transform:uppercase;color:var(--dim);padding:0.5rem 1rem 0.25rem;font-weight:600">Kelly Criterion</div>
                    <div class="guardian-stats-grid" id="guardianKelly">
                        <div class="guardian-stat"><div class="guardian-stat-label">Loading...</div><div class="guardian-stat-value">--</div></div>
                    </div>

                    <!-- Circuit Breakers -->
                    <div style="font-size:0.5rem;text-transform:uppercase;color:var(--dim);padding:0.5rem 1rem 0.25rem;font-weight:600">Circuit Breakers</div>
                    <div id="guardianBreakers" style="border-bottom:1px solid var(--border);padding-bottom:0.25rem">
                        <div style="padding:0.5rem 1rem;color:var(--dim);font-size:0.6rem">Loading...</div>
                    </div>

                    <!-- Debate Stats -->
                    <div style="font-size:0.5rem;text-transform:uppercase;color:var(--dim);padding:0.5rem 1rem 0.25rem;font-weight:600">Debate Stats (24h)</div>
                    <div class="guardian-stats-grid" id="guardianDebateStats">
                        <div class="guardian-stat"><div class="guardian-stat-label">Loading...</div><div class="guardian-stat-value">--</div></div>
                    </div>

                    <!-- Recent Debates -->
                    <div style="font-size:0.5rem;text-transform:uppercase;color:var(--dim);padding:0.5rem 1rem 0.25rem;font-weight:600">Recent Debates</div>
                    <div id="guardianDebates" style="padding-bottom:0.25rem">
                        <div style="padding:0.5rem 1rem;color:var(--dim);font-size:0.6rem">Loading...</div>
                    </div>
                </div>

                <!-- Execution Monitoring Dashboard -->
                <div class="em-section">
                    <div class="panel-header">
                        <span>Execution Monitor</span>
                        <span class="text-dim" id="emStatus">IDLE</span>
                    </div>

                    <!-- Execution Pipeline Stepper -->
                    <div class="em-pipeline" id="emPipeline">
                        <div class="em-step done" id="emStep1">
                            <div class="em-step-idx">Step 1</div>
                            <div class="em-step-name">TX Simulation</div>
                            <div class="em-step-status text-green" id="emStep1Status">✓ Passed</div>
                            <div class="em-step-bar"><div class="em-step-bar-fill"></div></div>
                        </div>
                        <div class="em-step done" id="emStep2">
                            <div class="em-step-idx">Step 2</div>
                            <div class="em-step-name">Guardian Validation</div>
                            <div class="em-step-status text-green" id="emStep2Status">✓ 4/4 Checks</div>
                            <div class="em-step-bar"><div class="em-step-bar-fill"></div></div>
                        </div>
                        <div class="em-step active" id="emStep3">
                            <div class="em-step-idx">Step 3</div>
                            <div class="em-step-name">Broadcast</div>
                            <div class="em-step-status" id="emStep3Status">Sending...</div>
                            <div class="em-step-bar"><div class="em-step-bar-fill" style="width:60%"></div></div>
                        </div>
                        <div class="em-step pending" id="emStep4">
                            <div class="em-step-idx">Step 4</div>
                            <div class="em-step-name">Confirmation</div>
                            <div class="em-step-status text-dim" id="emStep4Status">Waiting</div>
                            <div class="em-step-bar"><div class="em-step-bar-fill"></div></div>
                        </div>
                    </div>

                    <!-- Guardian Validator Checks + Simulation Result -->
                    <div class="em-guardian">
                        <div class="em-guardian-checks">
                            <div style="font-size:0.6rem;font-weight:600;margin-bottom:0.4rem;text-transform:uppercase">Guardian Validator</div>
                            <div class="em-check-row"><span class="em-check-icon pass" id="emChk1">✓</span> Transaction Simulation</div>
                            <div class="em-check-row"><span class="em-check-icon pass" id="emChk2">✓</span> Slippage Verification</div>
                            <div class="em-check-row"><span class="em-check-icon pass" id="emChk3">✓</span> Balance Confirmation</div>
                            <div class="em-check-row"><span class="em-check-icon pass" id="emChk4">✓</span> Rate Limit Check</div>
                        </div>
                        <div class="em-guardian-result">
                            <div style="font-size:0.6rem;font-weight:600;margin-bottom:0.4rem;text-transform:uppercase">Simulation Result</div>
                            <div style="font-size:0.6rem;color:var(--dim);margin-bottom:0.3rem">Slippage (Expected vs Actual)</div>
                            <div class="em-slippage-bar">
                                <span class="em-slip-label">Expected</span>
                                <div class="em-slip-track">
                                    <div class="em-slip-expected" id="emSlipExp" style="width:30%"></div>
                                    <div class="em-slip-actual" id="emSlipAct" style="width:35%"></div>
                                </div>
                                <span class="em-slip-label" style="text-align:right" id="emSlipValues">0.30% / 0.35%</span>
                            </div>
                            <div style="font-size:0.6rem;color:var(--dim);margin-bottom:0.3rem;margin-top:0.4rem">Retry Attempts</div>
                            <div class="em-retry-timeline" id="emRetryTimeline">
                                <div class="em-retry-dot success"></div>
                                <div class="em-retry-dot" style="background:#e8e8e8"></div>
                                <div class="em-retry-dot" style="background:#e8e8e8"></div>
                                <span style="font-size:0.55rem;color:var(--dim);margin-left:4px" id="emRetryLabel">1/3 attempts</span>
                            </div>
                            <div style="font-size:0.6rem;color:var(--dim);margin-bottom:0.3rem;margin-top:0.4rem">Confirmation Progress</div>
                            <div class="em-confirm-stepper" id="emConfStepper">
                                <div class="em-conf-step done">Submitted</div>
                                <div class="em-conf-step done">Processed</div>
                                <div class="em-conf-step active">Confirmed</div>
                                <div class="em-conf-step">Finalized</div>
                            </div>
                        </div>
                    </div>

                    <!-- TX Executor Metrics -->
                    <div class="em-tx-metrics">
                        <div class="em-tx-metric">
                            <div class="em-tx-label">MEV Protection</div>
                            <div class="em-tx-value text-green" id="emMev">JITO</div>
                            <div class="em-tx-sub">Bundle Active</div>
                        </div>
                        <div class="em-tx-metric">
                            <div class="em-tx-label">Priority Fee</div>
                            <div class="em-tx-value" id="emPriFee">0.00042</div>
                            <div class="em-tx-sub" id="emPriFeeSub">SOL · Dynamic</div>
                        </div>
                        <div class="em-tx-metric">
                            <div class="em-tx-label">Latency</div>
                            <div class="em-tx-value" id="emLatency">412ms</div>
                            <div class="em-tx-sub">Broadcast → Confirm</div>
                        </div>
                        <div class="em-tx-metric">
                            <div class="em-tx-label">TX Status</div>
                            <div class="em-tx-value text-green" id="emTxStatus">SUCCESS</div>
                            <div class="em-tx-sub" id="emTxSig">5Kx...r2M</div>
                        </div>
                    </div>
                </div>

                <!-- TradingView Chart -->
                <div class="tv-chart-section">
                    <div class="panel-header">
                        <span>Token Chart</span>
                        <span class="text-dim" id="tvPairLabel">SOL / USDC</span>
                    </div>
                    <div class="tv-chart-toolbar">
                        <div class="tv-search-wrap">
                            <input type="text" id="tvSearchInput" placeholder="Search token (e.g. BONK, JUP, WIF...)" autocomplete="off">
                            <div class="tv-search-results" id="tvSearchResults"></div>
                        </div>
                        <div class="tv-mode-buttons">
                            <button class="btn btn-sm active" onclick="tvSetMode('price', this)">Price</button>
                            <button class="btn btn-sm" onclick="tvSetMode('mcap', this)">MCap</button>
                        </div>
                        <div class="tv-tf-buttons">
                            <button class="btn btn-sm" onclick="tvLoadChart(null, 'hour', 1, 168, this)">1W</button>
                            <button class="btn btn-sm active" onclick="tvLoadChart(null, 'hour', 4, 180, this)">1M</button>
                            <button class="btn btn-sm" onclick="tvLoadChart(null, 'day', 1, 90, this)">3M</button>
                            <button class="btn btn-sm" onclick="tvLoadChart(null, 'day', 1, 365, this)">1Y</button>
                        </div>
                    </div>
                    <div class="tv-chart-container" id="tvChartContainer">
                        <div class="tv-loading" id="tvLoading">Loading chart...</div>
                    </div>
                </div>

                <div class="panel-header trades-header">
                    <div class="tab-group">
                        <div class="tab active" onclick="showTab('active')">Active</div>
                        <div class="tab" onclick="showTab('approved')">Approved</div>
                        <div class="tab" onclick="showTab('rejected')">Rejected</div>
                    </div>
                    <button class="btn btn-sm">Filter</button>
                </div>

                <div class="panel-content" id="trades-container">
                    <!-- Trade Row Header -->
                    <div class="trade-row trade-row-header">
                        <div>Pair / Type</div>
                        <div>Entry</div>
                        <div>Current</div>
                        <div>P&L</div>
                    </div>

                    <!-- Active Trades -->
                    <div class="trade-row" data-trade="trade1" onclick="toggleTradeExpand('trade1', this)">
                        <div>
                            <div class="trade-pair"><img src="assets/logos/solana-sol-logo.png" class="trade-pair-logo" alt="SOL">SOL/USDC</div>
                            <div class="trade-type long">LONG</div>
                        </div>
                        <div>$172.34</div>
                        <div>$178.42</div>
                        <div class="text-green">+3.52%</div>
                    </div>

                    <div class="trade-row" data-trade="trade2" onclick="toggleTradeExpand('trade2', this)">
                        <div>
                            <div class="trade-pair"><img src="assets/logos/raydium-ray-logo.svg" class="trade-pair-logo" alt="RAY">RAY/USDC</div>
                            <div class="trade-type long">LONG</div>
                        </div>
                        <div>$5.21</div>
                        <div>$5.67</div>
                        <div class="text-green">+8.83%</div>
                    </div>

                    <div class="trade-row" data-trade="trade3" onclick="toggleTradeExpand('trade3', this)">
                        <div>
                            <div class="trade-pair"><img src="assets/logos/jupiter-ag-jup-logo.svg" class="trade-pair-logo" alt="JUP">JUP/USDC</div>
                            <div class="trade-type short">SHORT</div>
                        </div>
                        <div>$1.31</div>
                        <div>$1.23</div>
                        <div class="text-green">+6.11%</div>
                    </div>

                    <div class="trade-row" data-trade="trade4" onclick="toggleTradeExpand('trade4', this)">
                        <div>
                            <div class="trade-pair">DRIFT/USDC</div>
                            <div class="trade-type long">LONG</div>
                        </div>
                        <div>$0.92</div>
                        <div>$0.89</div>
                        <div class="text-red">-3.26%</div>
                    </div>

                    <div class="trade-row" data-trade="trade5" onclick="toggleTradeExpand('trade5', this)">
                        <div>
                            <div class="trade-pair"><img src="assets/logos/bonk1-bonk-logo.svg" class="trade-pair-logo" alt="BONK">BONK/USDC</div>
                            <div class="trade-type long">LONG</div>
                        </div>
                        <div>$0.000021</div>
                        <div>$0.000024</div>
                        <div class="text-green">+14.28%</div>
                    </div>

                    <div class="trade-row" data-trade="trade6" onclick="toggleTradeExpand('trade6', this)">
                        <div>
                            <div class="trade-pair"><img src="assets/logos/orca-orca-logo.svg" class="trade-pair-logo" alt="ORCA">ORCA/USDC</div>
                            <div class="trade-type long">LONG</div>
                        </div>
                        <div>$4.12</div>
                        <div>$4.08</div>
                        <div class="text-red">-0.97%</div>
                    </div>
                </div>

                <!-- API Usage Heatmap -->
                <div class="api-usage-section">
                    <div class="panel-header">
                        <span>API Usage</span>
                        <span class="text-dim">Last 30 Days</span>
                    </div>
                    <div class="api-heatmap-container" id="apiHeatmap"></div>
                    <div class="api-legend">
                        <span>Less</span>
                        <canvas id="apiLegendBar" class="api-legend-bar" width="120" height="8"></canvas>
                        <span>More</span>
                    </div>
                </div>


            </div>

            <!-- Right Panel: Market Intelligence (fully dynamic) -->
            <div class="panel" id="miPanel">
                <div class="panel-header">
                    <span>Market Intelligence</span>
                    <button class="btn btn-sm" onclick="fetchCryptoNews()">↻</button>
                </div>
                <div id="miLiveBar"></div>
                <div id="miSentimentStrip"></div>
                <div id="miSentBadges"></div>
                <div id="miSparkline" class="mi-sparkline"></div>
                <div id="miTabs"></div>
                <div id="miFilters"></div>
                <div class="panel-content mi-feed" id="miFeed">
                    <div style="padding:2rem;text-align:center;color:var(--dim);font-size:0.7rem;">Connecting to sources...</div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <div>CORTEX AUTONOMOUS TRADING SYSTEM</div>
            <div>SOLANA MAINNET</div>
            <div>©2026 WIENER LABS</div>
        </footer>
    </div>

    <!-- Wallet Connection Modal -->
    <div class="modal-overlay" id="walletModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <span class="modal-title">Connect Wallet</span>
                <button class="modal-close" onclick="closeModal('walletModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="wallet-grid" id="walletGrid"></div>
            </div>
        </div>
    </div>
    <div class="wallet-error-toast" id="walletToast"></div>

    <div class="api-heatmap-tooltip" id="apiTooltip"></div>
    <div class="agent-perf-tooltip" id="agentPerfTooltip"></div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/guardian-service.js"></script>
    <script src="js/news-service.js"></script>
    <script src="js/regime-service.js"></script>

    <script>
    // === DATA SOURCES STATUS PANEL ===
    (function() {
        const DATA_SOURCES = [
            { name: 'Pyth', type: 'Oracle', interval: '400ms', dataTypes: 'Price feeds, confidence' },
            { name: 'Switchboard', type: 'Oracle', interval: '400ms', dataTypes: 'Price feeds, VRF' },
            { name: 'Birdeye', type: 'Token Data', interval: '1s', dataTypes: 'Token metrics, prices' },
            { name: 'Jupiter', type: 'DEX Agg', interval: '1s', dataTypes: 'Swap routes, quotes' },
            { name: 'Helius', type: 'RPC', interval: 'Per block', dataTypes: 'TX streams, webhooks' },
            { name: 'Protocol APIs', type: 'DeFi', interval: '5s', dataTypes: 'Drift, Orca, Kamino' },
            { name: 'Social Feeds', type: 'Sentiment', interval: '10s', dataTypes: 'Twitter, Discord, TG' },
            { name: 'Macro Data', type: 'Market', interval: '60s', dataTypes: 'BTC dom, fear/greed' },
            { name: 'News APIs', type: 'Intel', interval: '30s', dataTypes: 'CC, NewsData, Panic' },
        ];

        function randomLatency(base) {
            return Math.max(1, base + Math.round((Math.random() - 0.5) * base * 0.6));
        }

        function getSourceStatus() {
            return DATA_SOURCES.map(src => {
                const roll = Math.random();
                let status = 'online', latency;
                if (roll > 0.95) { status = 'offline'; latency = 0; }
                else if (roll > 0.85) { status = 'degraded'; }

                const baseLatencies = { '400ms': 8, '1s': 45, 'Per block': 420, '5s': 120, '10s': 350, '60s': 800, '30s': 500 };
                latency = latency === 0 ? 0 : randomLatency(baseLatencies[src.interval] || 100);
                if (status === 'degraded') latency = Math.round(latency * 2.5);

                const freshRoll = Math.random();
                let freshness = 'fresh';
                if (status === 'offline') freshness = 'dead';
                else if (status === 'degraded' || freshRoll > 0.8) freshness = 'stale';

                return { ...src, status, latency, freshness };
            });
        }

        function renderDataSources() {
            const sources = getSourceStatus();
            const onlineCount = sources.filter(s => s.status === 'online').length;
            const degradedCount = sources.filter(s => s.status === 'degraded').length;

            const summaryEl = document.getElementById('dsStatusSummary');
            if (degradedCount === 0 && onlineCount === sources.length) {
                summaryEl.innerHTML = sources.length + ' Sources · <span style="color:var(--green)">ALL ONLINE</span>';
            } else {
                summaryEl.innerHTML = onlineCount + '/' + sources.length + ' Online' +
                    (degradedCount > 0 ? ' · <span style="color:#cc8800">' + degradedCount + ' DEGRADED</span>' : '') +
                    ((sources.length - onlineCount - degradedCount) > 0 ? ' · <span style="color:var(--red)">' + (sources.length - onlineCount - degradedCount) + ' OFFLINE</span>' : '');
            }

            document.getElementById('dsGrid').innerHTML = sources.map(s => {
                const latStr = s.latency === 0 ? '—' : s.latency + 'ms';
                const latColor = s.status === 'offline' ? 'var(--red)' : s.latency > 500 ? 'var(--red)' : s.latency > 200 ? '#cc8800' : 'var(--fg)';
                return '<div class="ds-item">' +
                    '<div class="ds-name"><span class="ds-dot ' + s.status + '"></span>' + s.name + '</div>' +
                    '<div class="ds-meta">' + s.type + ' · ' + s.interval + '</div>' +
                    '<div class="ds-latency" style="color:' + latColor + '">' + latStr + '</div>' +
                    '<div class="ds-freshness ' + s.freshness + '">' + s.freshness.toUpperCase() + '</div>' +
                    '</div>';
            }).join('');

            // Macro indicators
            const btcDom = (54 + Math.random() * 8).toFixed(1);
            const fearGreed = Math.round(30 + Math.random() * 50);
            const fgLabel = fearGreed >= 60 ? 'GREED' : fearGreed >= 40 ? 'NEUTRAL' : 'FEAR';
            const fgColor = fearGreed >= 60 ? 'var(--green)' : fearGreed >= 40 ? 'var(--dim)' : 'var(--red)';
            const solDom = (2.5 + Math.random() * 1.5).toFixed(1);
            const gasAvg = (0.000005 + Math.random() * 0.00002).toFixed(6);

            document.getElementById('dsMacro').innerHTML =
                '<div class="ds-macro-item"><div class="ds-macro-label">BTC Dominance</div><div class="ds-macro-value">' + btcDom + '%</div></div>' +
                '<div class="ds-macro-item"><div class="ds-macro-label">Fear & Greed</div><div class="ds-macro-value" style="color:' + fgColor + '">' + fearGreed + ' · ' + fgLabel + '</div></div>' +
                '<div class="ds-macro-item"><div class="ds-macro-label">SOL Dominance</div><div class="ds-macro-value">' + solDom + '%</div></div>' +
                '<div class="ds-macro-item"><div class="ds-macro-label">Avg Gas (SOL)</div><div class="ds-macro-value">' + gasAvg + '</div></div>';
        }

        renderDataSources();
        setInterval(renderDataSources, 8000);
    })();
    </script>

    <script>
    // === EXECUTION MONITORING SIMULATION ===
    (function() {
        const STEPS = ['emStep1','emStep2','emStep3','emStep4'];
        const STEP_NAMES = ['TX Simulation','Guardian Validation','Broadcast','Confirmation'];
        const CHECKS = ['emChk1','emChk2','emChk3','emChk4'];
        const CHECK_NAMES = ['Transaction Simulation','Slippage Verification','Balance Confirmation','Rate Limit Check'];
        const CONF_STAGES = ['Submitted','Processed','Confirmed','Finalized'];
        const MEV_MODES = ['JITO','JITO','JITO','STANDARD'];
        const TX_SIGS = ['5Kx...r2M','8Fp...q4N','3Aw...j7T','9Bm...v1K','2Dz...h6R','7Gn...w3P'];

        function randFloat(min, max) { return (Math.random() * (max - min) + min); }
        function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function runExecCycle() {
            const statusEl = document.getElementById('emStatus');
            const totalDuration = randInt(3000, 6000);
            const stepDuration = totalDuration / 4;
            let failed = Math.random() < 0.08;
            let failStep = failed ? randInt(0, 3) : -1;

            statusEl.textContent = 'EXECUTING';
            statusEl.className = '';

            // Reset all
            STEPS.forEach((id, i) => {
                const el = document.getElementById(id);
                el.className = 'em-step pending';
                el.querySelector('.em-step-status').textContent = 'Waiting';
                el.querySelector('.em-step-status').className = 'em-step-status text-dim';
                el.querySelector('.em-step-bar-fill').style.width = '0%';
            });
            CHECKS.forEach(id => {
                const el = document.getElementById(id);
                el.textContent = '○'; el.className = 'em-check-icon wait';
            });

            // Animate steps sequentially
            STEPS.forEach((id, i) => {
                setTimeout(() => {
                    const el = document.getElementById(id);
                    const statusSpan = el.querySelector('.em-step-status');
                    const barFill = el.querySelector('.em-step-bar-fill');

                    if (failed && i === failStep) {
                        el.className = 'em-step failed';
                        statusSpan.textContent = '✗ Failed';
                        statusSpan.className = 'em-step-status text-red';
                        barFill.style.width = '100%';
                        statusEl.textContent = 'FAILED';
                        statusEl.className = 'text-red';
                        return;
                    }
                    if (failed && i > failStep) return;

                    el.className = 'em-step active';
                    statusSpan.textContent = 'Processing...';
                    statusSpan.className = 'em-step-status';
                    barFill.style.width = '60%';

                    // Guardian checks animate during step 2
                    if (i === 1) {
                        CHECKS.forEach((chkId, ci) => {
                            setTimeout(() => {
                                const chk = document.getElementById(chkId);
                                chk.textContent = '✓'; chk.className = 'em-check-icon pass';
                            }, (ci + 1) * (stepDuration / 5));
                        });
                    }

                    // Confirmation stepper during step 4
                    if (i === 3) {
                        const stepper = document.getElementById('emConfStepper');
                        CONF_STAGES.forEach((stage, si) => {
                            setTimeout(() => {
                                stepper.innerHTML = CONF_STAGES.map((s, j) =>
                                    '<div class="em-conf-step ' + (j <= si ? 'done' : j === si + 1 ? 'active' : '') + '">' + s + '</div>'
                                ).join('');
                            }, (si) * (stepDuration / 5));
                        });
                    }

                    setTimeout(() => {
                        if (failed && i >= failStep) return;
                        el.className = 'em-step done';
                        statusSpan.textContent = '✓ ' + (i === 1 ? '4/4 Checks' : 'Passed');
                        statusSpan.className = 'em-step-status text-green';
                        barFill.style.width = '100%';

                        if (i === STEPS.length - 1) {
                            statusEl.textContent = 'SUCCESS';
                            statusEl.className = 'text-green';
                        }
                    }, stepDuration * 0.85);
                }, i * stepDuration);
            });

            // Update metrics
            const expSlip = randFloat(0.1, 0.5);
            const actSlip = expSlip + randFloat(-0.05, 0.15);
            const expPct = Math.min(100, (expSlip / 1.0) * 100);
            const actPct = Math.min(100, (Math.max(0, actSlip) / 1.0) * 100);
            document.getElementById('emSlipExp').style.width = expPct + '%';
            document.getElementById('emSlipAct').style.width = actPct + '%';
            document.getElementById('emSlipValues').textContent = expSlip.toFixed(2) + '% / ' + Math.max(0, actSlip).toFixed(2) + '%';

            const retries = failed ? randInt(1, 3) : (Math.random() < 0.7 ? 1 : randInt(1, 2));
            const retryHtml = Array.from({length: 3}, (_, i) =>
                '<div class="em-retry-dot ' + (i < retries ? (i === retries - 1 && failed ? 'failed' : 'success') : 'pending') + '"></div>'
            ).join('') + '<span style="font-size:0.55rem;color:var(--dim);margin-left:4px">' + retries + '/3 attempts</span>';
            document.getElementById('emRetryTimeline').innerHTML = retryHtml;

            const mev = MEV_MODES[randInt(0, MEV_MODES.length - 1)];
            document.getElementById('emMev').textContent = mev;
            document.getElementById('emMev').className = 'em-tx-value ' + (mev === 'JITO' ? 'text-green' : '');

            document.getElementById('emPriFee').textContent = randFloat(0.00015, 0.0008).toFixed(5);
            document.getElementById('emLatency').textContent = randInt(280, 850) + 'ms';
            document.getElementById('emTxSig').textContent = TX_SIGS[randInt(0, TX_SIGS.length - 1)];

            setTimeout(() => {
                document.getElementById('emTxStatus').textContent = failed ? 'FAILED' : 'SUCCESS';
                document.getElementById('emTxStatus').className = 'em-tx-value ' + (failed ? 'text-red' : 'text-green');
            }, totalDuration);
        }

        runExecCycle();
        setInterval(runExecCycle, 8000);
    })();
    </script>

    <script>
        // TX Matrix initialization
        const txMatrixContainer = document.getElementById('txMatrixContainer');
        const txScanner = document.getElementById('txScanner');
        const txRowCount = 8;

        // Live Solana DEX transaction feed
        const TX_RPC = 'https://api.mainnet-beta.solana.com';
        const DEX_SOURCES = [
            { addr: 'JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4', label: 'JUP' },
            { addr: '675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8', label: 'RAY' },
        ];
        let liveTxBuffer = [];
        let txFetchInFlight = false;

        async function fetchLiveTxSignatures() {
            if (txFetchInFlight) return;
            txFetchInFlight = true;
            try {
                const results = await Promise.allSettled(DEX_SOURCES.map(async src => {
                    const res = await fetch(TX_RPC, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            jsonrpc: '2.0', id: 1,
                            method: 'getSignaturesForAddress',
                            params: [src.addr, { limit: 8 }]
                        })
                    });
                    if (!res.ok) throw new Error(src.label + ' HTTP ' + res.status);
                    const json = await res.json();
                    if (json.error) { console.warn('[TX]', src.label, 'RPC error:', json.error.message); return []; }
                    if (!json.result) return [];
                    return json.result.map(tx => ({
                        sig: tx.signature.slice(0, 4) + '...' + tx.signature.slice(-4),
                        fullSig: tx.signature,
                        label: src.label,
                        ok: tx.err === null,
                        time: tx.blockTime,
                        status: tx.confirmationStatus
                    }));
                }));
                const merged = results
                    .filter(r => r.status === 'fulfilled')
                    .flatMap(r => r.value)
                    .sort((a, b) => (b.time || 0) - (a.time || 0));
                if (merged.length > 0) liveTxBuffer = merged;
                console.log('[TX] Fetched', merged.length, 'live DEX signatures');
                results.filter(r => r.status === 'rejected').forEach(r => console.warn('[TX] Source failed:', r.reason));
            } catch (e) {
                console.warn('[TX] Fetch error:', e.message);
            } finally {
                txFetchInFlight = false;
            }
        }

        for (let i = 0; i < txRowCount; i++) {
            const row = document.createElement('div');
            row.className = 'tx-matrix-row';
            row.innerHTML = `
                <div class="tx-row-idx">${i.toString(16).toUpperCase().padStart(2, '0')}</div>
                <div class="tx-row-data" id="tx-data-${i}">-- -- -- --</div>
                <div class="tx-row-status" id="tx-status-${i}">--</div>
            `;
            txMatrixContainer.insertBefore(row, txScanner);
        }

        let currentTxRow = 0;
        let txCycleIdx = 0;

        function updateTxMatrix() {
            txScanner.style.top = `${currentTxRow * 22}px`;
            const dataEl = document.getElementById(`tx-data-${currentTxRow}`);
            const statusEl = document.getElementById(`tx-status-${currentTxRow}`);

            if (liveTxBuffer.length === 0) {
                dataEl.innerText = 'FETCHING LIVE TX...';
                currentTxRow = (currentTxRow + 1) % txRowCount;
                return;
            }

            const entry = liveTxBuffer[txCycleIdx % liveTxBuffer.length];
            const labelColor = entry.label === 'JUP' ? '#888888' : '#bbbbbb';
            dataEl.innerHTML = '<span style="color:' + labelColor + '">' + entry.label + '</span> \u00b7 ' + entry.sig;
            dataEl.classList.add('active');
            statusEl.innerText = entry.ok ? 'OK' : 'FL';
            statusEl.className = 'tx-row-status ' + (entry.ok ? 'confirmed' : '');

            const prevRow = currentTxRow === 0 ? txRowCount - 1 : currentTxRow - 1;
            document.getElementById(`tx-data-${prevRow}`).classList.remove('active');

            currentTxRow = (currentTxRow + 1) % txRowCount;
            txCycleIdx++;
        }

        fetchLiveTxSignatures();
        setInterval(updateTxMatrix, 150);
        setInterval(fetchLiveTxSignatures, 10000);

        // Performance Graphs (light theme)
        function initGraph(canvasId, color, speed) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let data = new Array(50).fill(0.5);
            let time = 0;

            function resize() {
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
            }
            window.addEventListener('resize', resize);
            resize();

            function draw() {
                time += speed;
                const noise = (Math.random() - 0.5) * 0.1;
                const trend = Math.sin(time) * 0.3 + 0.5;
                const newVal = Math.max(0.1, Math.min(0.9, trend + noise));

                data.push(newVal);
                data.shift();

                // Light background
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Grid line
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();

                // Data line (dark on light)
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                const step = canvas.width / (data.length - 1);

                for (let i = 0; i < data.length; i++) {
                    const x = i * step;
                    const y = canvas.height - (data[i] * canvas.height);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                // End dot
                const lastX = canvas.width;
                const lastY = canvas.height - (data[data.length - 1] * canvas.height);
                ctx.beginPath();
                ctx.arc(lastX - 2, lastY, 2, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();

                requestAnimationFrame(draw);
            }
            draw();
        }

        initGraph('canvasLoss', '#080808', 0.05);
        initGraph('canvasAcc', '#080808', 0.02);

        // Wave selector
        function setWave(el) {
            document.querySelectorAll('.wave-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        // Slider drag
        function startDrag(e, valId, min, max, precision) {
            const container = e.currentTarget;
            const thumb = container.querySelector('.slider-thumb-widget');
            const output = document.getElementById(valId);

            function onMove(moveEvent) {
                const rect = container.getBoundingClientRect();
                let x = moveEvent.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                const pct = x / rect.width;

                thumb.style.left = `${pct * 100}%`;

                const val = min + (pct * (max - min));
                output.innerText = val.toFixed(precision);
            }

            function onUp() {
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onUp);
            }

            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onUp);
            onMove(e);
        }

        // --- Trade Data & Inline Expansion ---
        const TRADES = {
            trade1: {
                pair: 'SOL/USDC', dir: 'LONG', dirClass: 'text-green',
                entry: '$172.34', current: '$178.42', size: '12.5 SOL', leverage: '2x',
                pnl: '+$76.00', pnlPct: '+3.52%', pnlClass: 'text-green',
                liq: '$86.17', tp: '$195.00', sl: '$165.00',
                votes: [1,1,1,1,0], decision: 'APPROVED (4/5)', decClass: 'text-green',
                opened: '2026-02-08 14:23 UTC', regime: 'ACCUMULATION',
                initiator: 'Momentum Agent', tx: '5xK9...7mPq',
            },
            trade2: {
                pair: 'RAY/USDC', dir: 'LONG', dirClass: 'text-green',
                entry: '$5.21', current: '$5.67', size: '1,840 RAY', leverage: '3x',
                pnl: '+$846.72', pnlPct: '+8.83%', pnlClass: 'text-green',
                liq: '$1.74', tp: '$6.80', sl: '$4.70',
                votes: [1,1,1,0,1], decision: 'APPROVED (4/5)', decClass: 'text-green',
                opened: '2026-02-07 09:41 UTC', regime: 'ACCUMULATION',
                initiator: 'Mean Rev Agent', tx: '8bR2...kN4x',
            },
            trade3: {
                pair: 'JUP/USDC', dir: 'SHORT', dirClass: 'text-red',
                entry: '$1.31', current: '$1.23', size: '6,200 JUP', leverage: '2x',
                pnl: '+$496.00', pnlPct: '+6.11%', pnlClass: 'text-green',
                liq: '$2.62', tp: '$1.05', sl: '$1.45',
                votes: [1,0,1,1,1], decision: 'APPROVED (4/5)', decClass: 'text-green',
                opened: '2026-02-08 11:07 UTC', regime: 'DISTRIBUTION',
                initiator: 'Sentiment Agent', tx: '3pLm...vQ8z',
            },
            trade4: {
                pair: 'DRIFT/USDC', dir: 'LONG', dirClass: 'text-green',
                entry: '$0.92', current: '$0.89', size: '4,500 DRIFT', leverage: '2x',
                pnl: '-$135.00', pnlPct: '-3.26%', pnlClass: 'text-red',
                liq: '$0.46', tp: '$1.15', sl: '$0.82',
                votes: [1,1,0,1,0], decision: 'APPROVED (3/5)', decClass: 'text-green',
                opened: '2026-02-08 16:52 UTC', regime: 'ACCUMULATION',
                initiator: 'Momentum Agent', tx: '9wXk...hT2a',
            },
            trade5: {
                pair: 'BONK/USDC', dir: 'LONG', dirClass: 'text-green',
                entry: '$0.000021', current: '$0.000024', size: '145.2M BONK', leverage: '1x',
                pnl: '+$435.60', pnlPct: '+14.28%', pnlClass: 'text-green',
                liq: 'N/A', tp: '$0.000030', sl: '$0.000018',
                votes: [1,1,1,1,1], decision: 'APPROVED (5/5)', decClass: 'text-green',
                opened: '2026-02-06 22:15 UTC', regime: 'MARKUP',
                initiator: 'Arbitrage Agent', tx: '2nFg...pR7m',
            },
            trade6: {
                pair: 'ORCA/USDC', dir: 'LONG', dirClass: 'text-green',
                entry: '$4.12', current: '$4.08', size: '820 ORCA', leverage: '2x',
                pnl: '-$32.80', pnlPct: '-0.97%', pnlClass: 'text-red',
                liq: '$2.06', tp: '$5.00', sl: '$3.80',
                votes: [1,0,1,1,0], decision: 'APPROVED (3/5)', decClass: 'text-green',
                opened: '2026-02-09 01:33 UTC', regime: 'ACCUMULATION',
                initiator: 'Risk Agent', tx: '7kBw...cJ5n',
            },
        };

        const AGENTS = ['Momentum', 'Mean Rev', 'Sentiment', 'Risk', 'Arbitrage'];
        let expandedTradeId = null;

        function buildTradeDetail(t) {
            const votesHtml = t.votes.map((v, i) => {
                const cls = v ? 'approve' : 'reject';
                const label = v ? 'APPROVE' : 'REJECT';
                return '<div class="consensus-vote ' + cls + '">' + label + '<div class="vote-agent">' + AGENTS[i] + '</div></div>';
            }).join('');

            return '<div class="trade-expand-inner">' +
                '<button class="trade-expand-close" onclick="collapseTradeExpand(event)">&times;</button>' +
                '<div class="trade-detail-grid">' +
                    '<div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Position Info</div>' +
                            '<div class="detail-row"><span class="detail-label">Direction</span><span class="' + t.dirClass + '">' + t.dir + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Entry Price</span><span>' + t.entry + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Current Price</span><span>' + t.current + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Size</span><span>' + t.size + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Leverage</span><span>' + t.leverage + '</span></div>' +
                        '</div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">P&L Analysis</div>' +
                            '<div class="detail-row"><span class="detail-label">Unrealized P&L</span><span class="' + t.pnlClass + '">' + t.pnl + ' (' + t.pnlPct + ')</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Liquidation Price</span><span>' + t.liq + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Take Profit</span><span>' + t.tp + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Stop Loss</span><span>' + t.sl + '</span></div>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Agent Consensus</div>' +
                            '<div class="detail-row"><span class="detail-label">Decision</span><span class="' + t.decClass + '">' + t.decision + '</span></div>' +
                            '<div class="consensus-grid">' + votesHtml + '</div>' +
                        '</div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Trade Metadata</div>' +
                            '<div class="detail-row"><span class="detail-label">Opened</span><span>' + t.opened + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Regime at Entry</span><span>' + t.regime + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Initiator</span><span>' + t.initiator + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">TX Hash</span><span style="font-size:0.65rem;">' + t.tx + '</span></div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="trade-expand-actions">' +
                    '<button class="btn">Modify Position</button>' +
                    '<button class="btn" style="border-color:var(--red);color:var(--red);">Close Position</button>' +
                '</div>' +
            '</div>';
        }

        function collapseTradeExpand(e) {
            if (e) e.stopPropagation();
            const existing = document.querySelector('.trade-expand');
            if (existing) {
                existing.classList.remove('open');
                setTimeout(() => existing.remove(), 300);
            }
            document.querySelectorAll('.trade-row.expanded').forEach(r => r.classList.remove('expanded'));
            expandedTradeId = null;
        }

        function toggleTradeExpand(tradeId, rowEl) {
            if (expandedTradeId === tradeId) {
                collapseTradeExpand();
                return;
            }

            collapseTradeExpand();

            const trade = TRADES[tradeId];
            if (!trade) return;

            expandedTradeId = tradeId;
            rowEl.classList.add('expanded');

            const expandDiv = document.createElement('div');
            expandDiv.className = 'trade-expand';
            expandDiv.innerHTML = buildTradeDetail(trade);
            rowEl.after(expandDiv);

            requestAnimationFrame(() => {
                requestAnimationFrame(() => expandDiv.classList.add('open'));
            });
        }

        // --- Agent Data & Inline Expansion ---
        const AGENTS_DATA = {
            momentum: {
                name: 'Momentum Agent',
                status: 'ACTIVE', statusClass: 'text-green',
                signal: 'LONG', signalClass: 'text-green',
                confidence: '87%', lastUpdate: '12s ago',
                winRate: '68.4%', totalTrades: 47, avgReturn: '+2.34%', avgReturnClass: 'text-green', sharpe: '1.82',
                lookback: '20 candles', threshold: '1.5 std dev', maxPos: '15% portfolio', regimeAdj: 'ON', regimeAdjClass: 'text-green',
                analysis: 'Strong momentum detected on SOL/USDC. Price broke above 20-period EMA with increasing volume. RSI at 62, not yet overbought. Regime classification supports trend-following strategies. Recommend maintaining long bias with trailing stop at $165.',
            },
            meanrev: {
                name: 'Mean Reversion Agent',
                status: 'ACTIVE', statusClass: 'text-green',
                signal: 'SHORT', signalClass: 'text-red',
                confidence: '73%', lastUpdate: '8s ago',
                winRate: '72.1%', totalTrades: 38, avgReturn: '+1.87%', avgReturnClass: 'text-green', sharpe: '2.14',
                lookback: '50 candles', threshold: '2.0 std dev', maxPos: '12% portfolio', regimeAdj: 'ON', regimeAdjClass: 'text-green',
                analysis: 'SOL/USDC trading 1.8 std dev above 50-period mean. Bollinger Band squeeze detected — expecting reversion. Z-score at 1.92 suggests overextension. Historical mean reversion probability at this level: 71%. Recommend short entry with tight stop above upper band.',
            },
            sentiment: {
                name: 'Sentiment Agent',
                status: 'ACTIVE', statusClass: 'text-green',
                signal: 'LONG', signalClass: 'text-green',
                confidence: '64%', lastUpdate: '45s ago',
                winRate: '61.8%', totalTrades: 52, avgReturn: '+1.42%', avgReturnClass: 'text-green', sharpe: '1.31',
                lookback: '24h rolling', threshold: '0.6 sentiment score', maxPos: '10% portfolio', regimeAdj: 'OFF', regimeAdjClass: 'text-dim',
                analysis: 'Social sentiment for SOL is net positive. Twitter mention volume up 34% in last 6h. Weighted sentiment score: 0.72 (bullish). Key influencer @solaboratory posted positive analysis. Caution: sentiment can reverse quickly on whale movements.',
            },
            risk: {
                name: 'Risk Agent',
                status: 'WARNING', statusClass: 'text-dim',
                signal: 'HEDGE', signalClass: 'text-dim',
                confidence: '91%', lastUpdate: '3s ago',
                winRate: '74.2%', totalTrades: 29, avgReturn: '+0.89%', avgReturnClass: 'text-green', sharpe: '2.67',
                lookback: 'Real-time', threshold: '5% max drawdown', maxPos: '20% portfolio', regimeAdj: 'ON', regimeAdjClass: 'text-green',
                analysis: 'Portfolio VaR (95%) at $2,341. Current drawdown: 1.8% from peak. Correlation between SOL and RAY positions elevated at 0.82 — consider reducing correlated exposure. Liquidation distance healthy across all positions. Recommend partial hedge on SOL via put options.',
            },
            arbitrage: {
                name: 'Arbitrage Agent',
                status: 'ACTIVE', statusClass: 'text-green',
                signal: 'LONG', signalClass: 'text-green',
                confidence: '95%', lastUpdate: '1s ago',
                winRate: '83.6%', totalTrades: 124, avgReturn: '+0.34%', avgReturnClass: 'text-green', sharpe: '3.41',
                lookback: 'Real-time', threshold: '0.15% spread', maxPos: '8% portfolio', regimeAdj: 'OFF', regimeAdjClass: 'text-dim',
                analysis: 'Cross-DEX spread on SOL/USDC: Jupiter $178.42 vs Orca $178.38 (0.02%). Below threshold — no arb opportunity. BONK/USDC showing 0.18% spread between Raydium and Jupiter — executing. Latency: 340ms avg. Gas optimization active.',
            },
        };

        let expandedAgentId = null;

        function buildAgentDetail(a) {
            return '<div class="agent-expand-inner">' +
                '<button class="agent-expand-close" onclick="collapseAgentExpand(event)">&times;</button>' +
                '<div class="trade-detail-grid">' +
                    '<div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Agent Status</div>' +
                            '<div class="detail-row"><span class="detail-label">Status</span><span class="' + a.statusClass + '">' + a.status + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Current Signal</span><span class="' + a.signalClass + '">' + a.signal + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Confidence</span><span>' + a.confidence + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Last Update</span><span>' + a.lastUpdate + '</span></div>' +
                        '</div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Performance (30D)</div>' +
                            '<div class="detail-row"><span class="detail-label">Win Rate</span><span>' + a.winRate + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Total Trades</span><span>' + a.totalTrades + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Avg Return</span><span class="' + a.avgReturnClass + '">' + a.avgReturn + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Sharpe Ratio</span><span>' + a.sharpe + '</span></div>' +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Strategy Parameters</div>' +
                            '<div class="detail-row"><span class="detail-label">Lookback Period</span><span>' + a.lookback + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Threshold</span><span>' + a.threshold + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Max Position Size</span><span>' + a.maxPos + '</span></div>' +
                            '<div class="detail-row"><span class="detail-label">Regime Adjustment</span><span class="' + a.regimeAdjClass + '">' + a.regimeAdj + '</span></div>' +
                        '</div>' +
                        '<div class="detail-section">' +
                            '<div class="detail-section-title">Current Analysis</div>' +
                            '<div style="font-size:0.75rem;color:var(--dim);line-height:1.5;">' + a.analysis + '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        function collapseAgentExpand(e) {
            if (e) e.stopPropagation();
            if (!expandedAgentId) return;
            const prev = document.querySelector('.agent-card.expanded');
            if (prev) prev.classList.remove('expanded');
            const existing = document.querySelector('.agent-expand');
            if (existing) {
                existing.classList.remove('open');
                existing.addEventListener('transitionend', () => existing.remove(), { once: true });
            }
            expandedAgentId = null;
        }

        function toggleAgentExpand(agentId, cardEl) {
            if (expandedAgentId === agentId) {
                collapseAgentExpand();
                return;
            }

            collapseAgentExpand();

            const agent = AGENTS_DATA[agentId];
            if (!agent) return;

            expandedAgentId = agentId;
            cardEl.classList.add('expanded');

            const expandDiv = document.createElement('div');
            expandDiv.className = 'agent-expand';
            expandDiv.innerHTML = buildAgentDetail(agent);
            cardEl.after(expandDiv);

            requestAnimationFrame(() => {
                requestAnimationFrame(() => expandDiv.classList.add('open'));
            });
        }

        // News expansion is now handled in js/news-service.js

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Close modal / collapse trade on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                collapseTradeExpand();
                collapseExpand();
                collapseAgentExpand();
                document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.classList.remove('active');
                });
            }
        });

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Trade mode selection
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
            });
        });

        // === STRATEGY CONTROL PANEL ===
        const STRATEGIES = [
            {
                name: 'LP Rebalancing', allocation: 40, status: 'running', enabled: true,
                params: [
                    { key: 'Capital Allocation', val: '40%' },
                    { key: 'Max Positions', val: '3' },
                    { key: 'IL Threshold', val: '2-3%' },
                    { key: 'Slippage Tolerance', val: '0.5%' },
                    { key: 'ML Confidence', val: '≥ 84%' },
                ],
                metrics: [
                    { label: 'Active Positions', value: '2 / 3' },
                    { label: 'Current IL', value: '1.4%' },
                    { label: 'Fee APY', value: '38.2%' },
                    { label: 'Pool TVL', value: '$12.4M' },
                ],
                entry: ['ML confidence ≥ 84%', 'Pool TVL above minimum', 'Expected fee APY > gas costs', 'IL risk assessment acceptable'],
                exit: ['IL exceeds threshold', 'Pool TVL drops below minimum', 'Better opportunity identified', 'Strategy circuit breaker'],
            },
            {
                name: 'Arbitrage', allocation: 30, status: 'running', enabled: true,
                params: [
                    { key: 'Capital Allocation', val: '30%' },
                    { key: 'Max Concurrent', val: '5' },
                    { key: 'Min Spread', val: '≥ 0.5%' },
                    { key: 'ML Confidence', val: '≥ 80%' },
                    { key: 'Execution', val: 'Atomic + Jito' },
                ],
                metrics: [
                    { label: 'Active Trades', value: '3 / 5' },
                    { label: 'Avg Spread', value: '0.62%' },
                    { label: 'Success Rate', value: '81.3%' },
                    { label: 'Avg Latency', value: '340ms' },
                ],
                entry: ['Spread ≥ 0.5% detected', 'Sufficient liquidity both sides', 'MEV protection via Jito bundle', 'Atomic execution possible'],
                exit: ['Spread closed', 'Execution failed', 'Slippage > 2%', 'Latency > 500ms'],
            },
            {
                name: 'Perpetuals', allocation: 30, status: 'running', enabled: true,
                params: [
                    { key: 'Capital Allocation', val: '30%' },
                    { key: 'Max Leverage', val: '≤ 5x' },
                    { key: 'Max Hold Time', val: '8h' },
                    { key: 'Max Positions', val: '2' },
                    { key: 'Stop Loss', val: '5% (fixed)' },
                    { key: 'Take Profit', val: '10% (fixed)' },
                    { key: 'Liquidation Distance', val: '≥ 15%' },
                    { key: 'Min Margin Ratio', val: '20%' },
                    { key: 'Auto-deleverage', val: 'At 10% margin' },
                ],
                metrics: [
                    { label: 'Open Positions', value: '1 / 2' },
                    { label: 'Unrealized P&L', value: '+$142.30' },
                    { label: 'Margin Used', value: '34%' },
                    { label: 'Avg Hold', value: '4.2h' },
                ],
                entry: ['ML confidence threshold met', 'Funding rate favorable', 'Margin ratio sufficient', 'Risk manager approval'],
                exit: ['Stop loss hit (5%)', 'Take profit hit (10%)', 'Max hold time exceeded (8h)', 'Liquidation proximity warning'],
            },
        ];

        function switchStrategy(idx, tabEl) {
            document.querySelectorAll('.strat-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.strat-body').forEach(b => b.classList.remove('active'));
            tabEl.classList.add('active');
            document.getElementById('stratBody' + idx).classList.add('active');
        }

        function renderStrategyPanel(idx) {
            const s = STRATEGIES[idx];
            const el = document.getElementById('stratBody' + idx);

            let html = '<div class="strat-alloc">' +
                '<div class="strat-alloc-label"><span>Capital Allocation</span><span>' + s.allocation + '%</span></div>' +
                '<div class="strat-alloc-bar"><div class="strat-alloc-fill" style="width:' + s.allocation + '%"></div></div></div>';

            html += '<div class="strat-status-row">' +
                '<span class="strat-status-badge ' + s.status + '">' + s.status.toUpperCase() + '</span>' +
                '<div class="strat-toggle ' + (s.enabled ? 'on' : '') + '" onclick="toggleStrategy(' + idx + ', this)"></div></div>';

            html += '<div class="strat-metrics">';
            s.metrics.forEach(m => {
                const colorClass = m.value.startsWith('+') ? ' text-green' : m.value.startsWith('-') ? ' text-red' : '';
                html += '<div class="strat-metric"><div class="strat-metric-label">' + m.label + '</div><div class="strat-metric-value' + colorClass + '">' + m.value + '</div></div>';
            });
            html += '</div>';

            html += '<div class="strat-params">';
            s.params.forEach(p => {
                html += '<div class="strat-param-row"><span class="strat-param-key">' + p.key + '</span><span class="strat-param-val">' + p.val + '</span></div>';
            });
            html += '</div>';

            html += '<div class="strat-criteria"><div class="strat-criteria-title">Entry Criteria</div>';
            s.entry.forEach(c => { html += '<div class="strat-criteria-item">' + c + '</div>'; });
            html += '</div>';

            html += '<div class="strat-criteria"><div class="strat-criteria-title">Exit Triggers</div>';
            s.exit.forEach(c => { html += '<div class="strat-criteria-item">' + c + '</div>'; });
            html += '</div>';

            el.innerHTML = html;
        }

        function toggleStrategy(idx, toggleEl) {
            STRATEGIES[idx].enabled = !STRATEGIES[idx].enabled;
            STRATEGIES[idx].status = STRATEGIES[idx].enabled ? 'running' : 'paused';
            toggleEl.classList.toggle('on');
            renderStrategyPanel(idx);
        }

        STRATEGIES.forEach((_, i) => renderStrategyPanel(i));

        // Time filter selection
        document.querySelectorAll('.time-filter').forEach(filter => {
            filter.addEventListener('click', () => {
                document.querySelectorAll('.time-filter').forEach(f => f.classList.remove('active'));
                filter.classList.add('active');
            });
        });

        // Nav item selection (skip wallet nav — it has its own handler)
        document.querySelectorAll('.nav-item:not(#walletNav)').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item:not(#walletNav)').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
            });
        });

        // --- Wallet Connection + Live Data ---
        const WALLET_STORAGE_KEY = 'cortex_wallet';
        const SOL_RPC = 'https://api.mainnet-beta.solana.com';
        const JUPITER_PRICE_API = 'https://lite-api.jup.ag/price/v3';
        let walletState = null;
        let walletDataInterval = null;

        const KNOWN_MINTS = {
            'So11111111111111111111111111111111111111112': { sym: 'SOL', icon: 'assets/logos/solana-sol-logo.png', decimals: 9 },
            '4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R': { sym: 'RAY', icon: 'assets/logos/raydium-ray-logo.svg', decimals: 6 },
            'JUPyiwrYJFskUPiHa7hkeR8VUtAeFoSYbKedZNsDvCN': { sym: 'JUP', icon: 'assets/logos/jupiter-ag-jup-logo.svg', decimals: 6 },
            'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263': { sym: 'BONK', icon: 'assets/logos/bonk1-bonk-logo.svg', decimals: 5 },
            'DriFtupJYLTosbwoN8koMbEYSx54aFAVLddWsbksjwg7': { sym: 'DRIFT', icon: '', decimals: 6 },
            'orcaEKTdK7LKz57vaAYr9QeNsVEPfiu6QeMU1kektZE': { sym: 'ORCA', icon: 'assets/logos/orca-orca-logo.svg', decimals: 6 },
            'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v': { sym: 'USDC', icon: 'assets/logos/usd-coin-usdc-logo.svg', decimals: 6 },
            'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB': { sym: 'USDC', icon: 'assets/logos/usd-coin-usdc-logo.svg', decimals: 6 },
        };
        const SOL_MINT = 'So11111111111111111111111111111111111111112';

        const WALLETS = [
            { name: 'Phantom',   icon: 'P',  getProvider: () => window.phantom?.solana,  detect: () => !!window.phantom?.solana?.isPhantom },
            { name: 'Solflare',  icon: 'S',  getProvider: () => window.solflare,          detect: () => !!window.solflare?.isSolflare },
            { name: 'Backpack',  icon: 'B',  getProvider: () => window.backpack,           detect: () => !!window.backpack?.isBackpack },
            { name: 'Torus',     icon: 'T',  getProvider: () => window.torus?.solana,      detect: () => !!window.torus },
            { name: 'Coin98',    icon: 'C',  getProvider: () => window.coin98?.sol,        detect: () => !!window.coin98 },
            { name: 'Slope',     icon: 'Sl', getProvider: () => window.Slope ? new window.Slope() : null, detect: () => !!window.Slope },
            { name: 'Ledger',    icon: 'L',  getProvider: () => null, detect: () => false, installUrl: null, special: 'USB / Bluetooth' },
        ];

        let activeProvider = null;

        function getWalletConfig(name) {
            return WALLETS.find(w => w.name === name);
        }

        function renderWalletGrid() {
            const grid = document.getElementById('walletGrid');
            if (!grid) return;
            grid.innerHTML = WALLETS.map((w) => {
                const detected = w.detect();
                const isSpecial = !!w.special;
                const statusText = isSpecial ? w.special : (detected ? 'Detected' : 'Not Installed');
                const statusClass = isSpecial ? '' : (detected ? 'detected' : 'not-installed');
                const optClass = (!detected && !isSpecial) ? 'wallet-option not-available' : 'wallet-option';
                return '<div class="' + optClass + '" data-wallet="' + w.name + '" onclick="connectWallet(\'' + w.name + '\')">' +
                    '<div class="wallet-icon"><span class="wi-letter">' + w.icon + '</span></div>' +
                    '<div class="wallet-info">' +
                        '<div class="wallet-name">' + w.name + '</div>' +
                        '<div class="wallet-detect ' + statusClass + '">' + statusText + '</div>' +
                    '</div>' +
                    '<div class="wallet-spinner"></div>' +
                    '<span class="wallet-arrow">→</span>' +
                    '</div>';
            }).join('');
        }

        function showWalletToast(msg, duration) {
            const t = document.getElementById('walletToast');
            if (!t) return;
            t.textContent = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), duration || 3000);
        }

        function truncateAddress(addr) {
            return addr.slice(0, 4) + '...' + addr.slice(-4);
        }

        function fmtUsd(n) {
            if (Math.abs(n) >= 1) return n.toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 });
            return '$' + n.toFixed(6);
        }

        function fmtBal(n) {
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (n >= 1e4) return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
            if (n >= 1) return n.toLocaleString('en-US', { maximumFractionDigits: 2 });
            return n.toFixed(6);
        }

        function pnlClass(v) { return v >= 0 ? 'text-green' : 'text-red'; }
        function pnlSign(v) { return v >= 0 ? '+' : ''; }

        // --- Solana RPC helpers ---
        async function rpcCall(method, params) {
            const res = await fetch(SOL_RPC, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jsonrpc: '2.0', id: 1, method, params }),
            });
            const json = await res.json();
            if (json.error) throw new Error(json.error.message);
            return json.result;
        }

        async function fetchSolBalance(address) {
            const result = await rpcCall('getBalance', [address]);
            return (result.value || 0) / 1e9;
        }

        async function fetchTokenAccounts(address) {
            const result = await rpcCall('getTokenAccountsByOwner', [
                address,
                { programId: 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA' },
                { encoding: 'jsonParsed' },
            ]);
            const holdings = [];
            for (const acc of (result.value || [])) {
                const info = acc.account.data.parsed.info;
                const mint = info.mint;
                const amount = parseFloat(info.tokenAmount.uiAmountString || '0');
                if (amount > 0) holdings.push({ mint, amount });
            }
            return holdings;
        }

        async function fetchPrices(mints) {
            if (mints.length === 0) return {};
            const ids = mints.join(',');
            const res = await fetch(JUPITER_PRICE_API + '?ids=' + ids);
            if (!res.ok) throw new Error('Jupiter API HTTP ' + res.status);
            return await res.json();
        }

        // --- Core data fetch ---
        async function fetchWalletData(address) {
            const [solBal, tokenAccounts] = await Promise.all([
                fetchSolBalance(address),
                fetchTokenAccounts(address),
            ]);

            const holdings = [];
            const priceMints = [SOL_MINT];

            if (solBal > 0) {
                holdings.push({ mint: SOL_MINT, amount: solBal });
            }

            for (const ta of tokenAccounts) {
                holdings.push(ta);
                priceMints.push(ta.mint);
            }

            const priceData = await fetchPrices([...new Set(priceMints)]);

            const rows = holdings.map(h => {
                const known = KNOWN_MINTS[h.mint];
                const sym = known ? known.sym : h.mint.slice(0, 4) + '..';
                const icon = known ? known.icon : sym[0];
                const pd = priceData[h.mint];
                const price = pd ? pd.usdPrice : 0;
                const usdValue = h.amount * price;
                return { sym, icon, mint: h.mint, amount: h.amount, price, usdValue };
            });

            rows.sort((a, b) => b.usdValue - a.usdValue);
            return rows;
        }

        // --- Render wallet status ---
        function renderWalletStatus(rows) {
            const totalValue = rows.reduce((s, r) => s + r.usdValue, 0);
            const holdingsBody = document.getElementById('wsHoldingsBody');
            const pnlBanner = document.getElementById('wsPnlBanner');
            const liveTag = document.getElementById('wsLiveTag');

            liveTag.textContent = 'LIVE';
            liveTag.className = 'text-green';

            if (rows.length === 0) {
                pnlBanner.innerHTML = '<span class="ws-pnl-value text-dim">$0.00</span><span class="text-dim" style="font-size:0.65rem; margin-left:auto;">No holdings found</span>';
                holdingsBody.innerHTML = '<div style="padding:1rem;color:var(--dim);font-size:0.75rem;text-align:center;">No token holdings detected for this address</div>';
                renderTimePnl(0);
                return;
            }

            pnlBanner.innerHTML =
                '<span class="ws-pnl-value">' + fmtUsd(totalValue) + '</span>' +
                '<span class="text-dim" style="font-size:0.65rem; margin-left:auto;">Total Holdings</span>';

            let html = '';
            for (const r of rows) {
                html += '<div class="ws-holdings-row">' +
                    '<div class="ws-token-cell"><div class="ws-token-icon">' + (r.icon ? '<img src="' + r.icon + '" alt="' + r.sym + '">' : r.sym.charAt(0)) + '</div><span class="ws-token-sym">' + r.sym + '</span></div>' +
                    '<div>' + fmtBal(r.amount) + '</div>' +
                    '<div>' + fmtUsd(r.usdValue) + '</div>' +
                    '<div class="text-dim">—</div>' +
                    '</div>';
            }
            holdingsBody.innerHTML = html;

            // Fetch 24h price changes for P&L columns
            fetch24hChanges(rows, totalValue);
        }

        async function fetch24hChanges(rows, totalValue) {
            try {
                const mints = rows.map(r => r.mint);
                const res = await fetch(JUPITER_PRICE_API + '?ids=' + mints.join(','));
                if (!res.ok) { renderTimePnl(0, totalValue); return; }
                const data = await res.json();

                let totalChange24h = 0;
                const holdingsBody = document.getElementById('wsHoldingsBody');
                const rowEls = holdingsBody.querySelectorAll('.ws-holdings-row');

                rows.forEach((r, i) => {
                    const pd = data[r.mint];
                    const pct24h = (pd && typeof pd.priceChange24h === 'number') ? pd.priceChange24h : 0;
                    const dollarChange = r.usdValue * (pct24h / 100);
                    totalChange24h += dollarChange;

                    if (rowEls[i]) {
                        const pnlCell = rowEls[i].querySelector('div:last-child');
                        pnlCell.className = pnlClass(pct24h);
                        pnlCell.textContent = pnlSign(pct24h) + pct24h.toFixed(2) + '%';
                    }
                });

                renderTimePnl(totalChange24h, totalValue);
            } catch (_) {
                renderTimePnl(0, totalValue);
            }
        }

        function renderTimePnl(daily, totalValue) {
            const tv = totalValue || 1;
            const dailyPct = (daily / tv) * 100;
            const monthly = daily * 12.4;
            const monthlyPct = (monthly / tv) * 100;
            const yearly = daily * 87.2;
            const yearlyPct = (yearly / tv) * 100;
            const allTime = daily * 142;
            const allTimePct = (allTime / tv) * 100;

            const pairs = [
                ['wsPnlToday', 'wsPctToday', daily, dailyPct],
                ['wsPnlMonth', 'wsPctMonth', monthly, monthlyPct],
                ['wsPnlYear', 'wsPctYear', yearly, yearlyPct],
                ['wsPnlAll', 'wsPctAll', allTime, allTimePct],
            ];
            for (const [valId, pctId, val, pct] of pairs) {
                const valEl = document.getElementById(valId);
                const pctEl = document.getElementById(pctId);
                const cls = pnlClass(val);
                valEl.className = 'ws-time-value ' + cls;
                valEl.textContent = pnlSign(val) + fmtUsd(Math.abs(val));
                pctEl.className = 'ws-time-pct ' + cls;
                pctEl.textContent = pnlSign(pct) + pct.toFixed(2) + '%';
            }
        }

        // --- Wallet status visibility ---
        function showWalletStatus() {
            document.getElementById('walletStatus').style.display = '';
        }

        function hideWalletStatus() {
            document.getElementById('walletStatus').style.display = 'none';
            if (walletDataInterval) { clearInterval(walletDataInterval); walletDataInterval = null; }
        }

        function resetWalletStatusUI() {
            document.getElementById('wsPnlBanner').innerHTML = '<span class="ws-pnl-value text-dim">—</span>';
            document.getElementById('wsHoldingsBody').innerHTML = '';
            document.getElementById('wsLiveTag').textContent = 'LOADING...';
            document.getElementById('wsLiveTag').className = 'text-dim';
            ['wsPnlToday','wsPnlMonth','wsPnlYear','wsPnlAll'].forEach(id => {
                document.getElementById(id).textContent = '—';
                document.getElementById(id).className = 'ws-time-value text-dim';
            });
            ['wsPctToday','wsPctMonth','wsPctYear','wsPctAll'].forEach(id => {
                document.getElementById(id).textContent = '';
            });
        }

        async function loadWalletData(address) {
            resetWalletStatusUI();
            showWalletStatus();
            try {
                const rows = await fetchWalletData(address);
                renderWalletStatus(rows);
            } catch (err) {
                console.error('Wallet data fetch failed:', err);
                document.getElementById('wsLiveTag').textContent = 'ERROR';
                document.getElementById('wsLiveTag').className = 'text-red';
                document.getElementById('wsHoldingsBody').innerHTML =
                    '<div style="padding:1rem;color:var(--dim);font-size:0.75rem;text-align:center;">Failed to fetch on-chain data</div>';
            }
        }

        function startWalletPolling(address) {
            if (walletDataInterval) clearInterval(walletDataInterval);
            loadWalletData(address);
            walletDataInterval = setInterval(() => loadWalletData(address), 30000);
        }

        // --- Header UI ---
        function setWalletUI(state) {
            const label = document.getElementById('walletLabel');
            const nav = document.getElementById('walletNav');
            if (state) {
                label.innerHTML = '<span class="wallet-addr">' + truncateAddress(state.address) + '</span>';
                nav.classList.add('active');
                startWalletPolling(state.address);
            } else {
                label.textContent = 'Connect';
                nav.classList.remove('active');
                hideWalletStatus();
            }
        }

        function handleWalletClick() {
            if (walletState) {
                document.getElementById('walletDropdown').classList.toggle('open');
            } else {
                renderWalletGrid();
                document.getElementById('walletModal').classList.add('active');
            }
        }

        async function connectWallet(walletName) {
            const cfg = getWalletConfig(walletName);
            if (!cfg) return;

            if (cfg.special) {
                showWalletToast(walletName + ' requires a dedicated app or hardware device', 3000);
                return;
            }

            if (!cfg.detect()) {
                showWalletToast(walletName + ' is not installed. Please install the extension.', 3000);
                return;
            }

            const optEl = document.querySelector('[data-wallet="' + walletName + '"]');
            if (optEl) optEl.classList.add('connecting');

            try {
                const provider = cfg.getProvider();
                if (!provider) throw new Error('Provider not available');

                const resp = await provider.connect();
                const publicKey = resp.publicKey || provider.publicKey;
                if (!publicKey) throw new Error('No public key returned');

                const address = publicKey.toString();
                activeProvider = provider;
                walletState = { wallet: walletName, address: address };
                localStorage.setItem(WALLET_STORAGE_KEY, JSON.stringify(walletState));
                setWalletUI(walletState);
                closeModal('walletModal');
            } catch (err) {
                const msg = err.code === 4001 ? 'Connection rejected by user'
                    : err.message || 'Connection failed';
                showWalletToast(walletName + ': ' + msg, 4000);
            } finally {
                if (optEl) optEl.classList.remove('connecting');
            }
        }

        async function disconnectWallet(e) {
            e.stopPropagation();
            if (activeProvider && typeof activeProvider.disconnect === 'function') {
                try { await activeProvider.disconnect(); } catch (_) {}
            }
            activeProvider = null;
            walletState = null;
            localStorage.removeItem(WALLET_STORAGE_KEY);
            document.getElementById('walletDropdown').classList.remove('open');
            setWalletUI(null);
        }

        function copyAddress(e) {
            e.stopPropagation();
            if (!walletState) return;
            navigator.clipboard.writeText(walletState.address).then(() => {
                showWalletToast('Address copied to clipboard', 2000);
            });
            document.getElementById('walletDropdown').classList.remove('open');
        }

        function viewOnSolscan(e) {
            e.stopPropagation();
            if (!walletState) return;
            window.open('https://solscan.io/account/' + walletState.address, '_blank');
            document.getElementById('walletDropdown').classList.remove('open');
        }

        document.addEventListener('click', (e) => {
            const nav = document.getElementById('walletNav');
            if (!nav.contains(e.target)) {
                document.getElementById('walletDropdown').classList.remove('open');
            }
        });

        // Restore wallet from localStorage — attempt eager reconnect
        (async function restoreWallet() {
            const stored = localStorage.getItem(WALLET_STORAGE_KEY);
            if (!stored) return;
            try {
                const parsed = JSON.parse(stored);
                const cfg = getWalletConfig(parsed.wallet);
                if (!cfg || !cfg.detect()) {
                    walletState = parsed;
                    setWalletUI(walletState);
                    return;
                }
                const provider = cfg.getProvider();
                if (!provider) {
                    walletState = parsed;
                    setWalletUI(walletState);
                    return;
                }
                // Eager reconnect — Phantom/Solflare support { onlyIfTrusted: true }
                const resp = await provider.connect({ onlyIfTrusted: true });
                const publicKey = resp.publicKey || provider.publicKey;
                const address = publicKey ? publicKey.toString() : parsed.address;
                activeProvider = provider;
                walletState = { wallet: parsed.wallet, address: address };
                localStorage.setItem(WALLET_STORAGE_KEY, JSON.stringify(walletState));
                setWalletUI(walletState);
            } catch (_) {
                // Eager reconnect failed (user hasn't approved) — show stored state anyway
                try {
                    walletState = JSON.parse(stored);
                    setWalletUI(walletState);
                } catch (__) {
                    localStorage.removeItem(WALLET_STORAGE_KEY);
                }
            }
        })();

        // Simulate live price updates
        function updateTicker() {
            const changes = document.querySelectorAll('.ticker-item .change');
            changes.forEach(change => {
                const isUp = Math.random() > 0.4;
                const value = (Math.random() * 5).toFixed(2);
                change.textContent = isUp ? `+${value}%` : `-${value}%`;
                change.className = `change ${isUp ? 'up' : 'down'}`;
            });
        }

        setInterval(updateTicker, 5000);

        // --- Active Positions Grid (animated removal) ---
        const POSITION_POOL = [
            { pair: 'SOL/USDC', logo: 'assets/logos/solana-sol-logo.png', side: 'LONG', sideClass: 'text-green', entry: 172.40 },
            { pair: 'RAY/USDC', logo: 'assets/logos/raydium-ray-logo.svg', side: 'LONG', sideClass: 'text-green', entry: 2.84 },
            { pair: 'JUP/USDC', logo: 'assets/logos/jupiter-ag-jup-logo.svg', side: 'LONG', sideClass: 'text-green', entry: 1.12 },
            { pair: 'BONK/USDC', logo: 'assets/logos/bonk1-bonk-logo.svg', side: 'SHORT', sideClass: 'text-red', entry: 0.000031 },
            { pair: 'ORCA/USDC', logo: 'assets/logos/orca-orca-logo.svg', side: 'LONG', sideClass: 'text-green', entry: 4.12 },
            { pair: 'SOL/USDC', logo: 'assets/logos/solana-sol-logo.png', side: 'SHORT', sideClass: 'text-red', entry: 180.20 },
            { pair: 'RAY/USDC', logo: 'assets/logos/raydium-ray-logo.svg', side: 'SHORT', sideClass: 'text-red', entry: 3.10 },
            { pair: 'JUP/USDC', logo: 'assets/logos/jupiter-ag-jup-logo.svg', side: 'SHORT', sideClass: 'text-red', entry: 1.28 },
            { pair: 'ORCA/USDC', logo: 'assets/logos/orca-orca-logo.svg', side: 'SHORT', sideClass: 'text-red', entry: 4.50 },
            { pair: 'SOL/USDC', logo: 'assets/logos/solana-sol-logo.png', side: 'LONG', sideClass: 'text-green', entry: 168.90 },
        ];

        let activePositions = [];

        function buildPosCard(pos, idx) {
            const pnl = ((Math.random() - 0.4) * 10).toFixed(2);
            const isUp = parseFloat(pnl) >= 0;
            return '<div class="pos-card" data-pos-idx="' + idx + '">' +
                '<button class="pos-card-close" onclick="closePosition(' + idx + ')">&times;</button>' +
                '<div class="pos-card-pair"><img src="' + pos.logo + '" alt="">' + pos.pair + '</div>' +
                '<div class="pos-card-meta"><span class="' + pos.sideClass + '">' + pos.side + '</span> · $' + pos.entry + '</div>' +
                '<div class="pos-card-pnl ' + (isUp ? 'text-green' : 'text-red') + '">' + (isUp ? '+' : '') + pnl + '%</div>' +
            '</div>';
        }

        function renderPositions() {
            const grid = document.getElementById('positionsGrid');
            grid.innerHTML = activePositions.map((p, i) => buildPosCard(p, i)).join('');
            document.getElementById('posCount').textContent = activePositions.length + ' OPEN';
        }

        function closePosition(idx) {
            const card = document.querySelector('.pos-card[data-pos-idx="' + idx + '"]');
            if (!card) return;
            card.classList.add('removing');
            card.addEventListener('transitionend', function() {
                activePositions.splice(idx, 1);
                renderPositions();
            }, { once: true });
        }

        function closeRandomPosition() {
            if (activePositions.length === 0) return;
            const idx = Math.floor(Math.random() * activePositions.length);
            closePosition(idx);
        }

        function resetPositions() {
            activePositions = POSITION_POOL.map(p => ({ ...p }));
            renderPositions();
        }

        resetPositions();

        // --- TradingView Lightweight Charts ---
        const TV_DEFAULT_POOL = '7qbRF6YsyGuLUVs6Y1q64bdVrfe4ZcUUz1JRdoVNUJnm';
        let tvChart = null;
        let tvCandleSeries = null;
        let tvVolumeSeries = null;
        let tvCurrentPool = TV_DEFAULT_POOL;
        let tvCurrentTf = 'hour';
        let tvCurrentAgg = 4;
        let tvCurrentLimit = 180;
        let tvSearchTimeout = null;
        let tvMode = 'price';
        let tvSupplyCache = {};

        async function tvFetchPoolInfo(poolAddress) {
            if (tvSupplyCache[poolAddress]) return tvSupplyCache[poolAddress];
            const url = 'https://api.geckoterminal.com/api/v2/networks/solana/pools/' + poolAddress;
            const res = await fetch(url);
            if (!res.ok) throw new Error('Pool info fetch failed');
            const json = await res.json();
            const attrs = json.data.attributes;
            const mcap = parseFloat(attrs.market_cap_usd || attrs.fdv_usd || 0);
            const price = parseFloat(attrs.base_token_price_usd || 0);
            const supply = price > 0 ? mcap / price : 0;
            tvSupplyCache[poolAddress] = { mcap, price, supply };
            return tvSupplyCache[poolAddress];
        }

        function tvSetMode(mode, btn) {
            tvMode = mode;
            document.querySelectorAll('.tv-mode-buttons .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            tvSupplyCache = {};
            tvLoadChart(null, null, null, null, null);
        }

        function tvInitChart() {
            const container = document.getElementById('tvChartContainer');
            tvChart = LightweightCharts.createChart(container, {
                layout: {
                    textColor: '#666666',
                    background: { type: 'solid', color: '#ffffff' },
                    fontFamily: "'Alliance No.2', sans-serif",
                    fontSize: 10
                },
                grid: {
                    vertLines: { color: '#f0f0f0' },
                    horzLines: { color: '#f0f0f0' }
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal
                },
                rightPriceScale: {
                    borderColor: '#cccccc'
                },
                timeScale: {
                    borderColor: '#cccccc',
                    timeVisible: true,
                    secondsVisible: false
                },
                handleScroll: true,
                handleScale: true
            });

            tvCandleSeries = tvChart.addSeries(LightweightCharts.CandlestickSeries, {
                upColor: '#00aa00',
                downColor: '#cc0000',
                wickUpColor: '#00aa00',
                wickDownColor: '#cc0000',
                borderVisible: false
            });

            tvVolumeSeries = tvChart.addSeries(LightweightCharts.HistogramSeries, {
                priceFormat: { type: 'volume' },
                priceScaleId: ''
            });
            tvVolumeSeries.priceScale().applyOptions({
                scaleMargins: { top: 0.8, bottom: 0 }
            });

            new ResizeObserver(() => {
                tvChart.applyOptions({ width: container.clientWidth });
            }).observe(container);

            tvLoadChart(TV_DEFAULT_POOL, 'hour', 4, 180, document.querySelector('.tv-tf-buttons .btn.active'));
        }

        async function tvFetchOHLCV(poolAddress, timeframe, aggregate, limit) {
            const url = 'https://api.geckoterminal.com/api/v2/networks/solana/pools/' +
                poolAddress + '/ohlcv/' + timeframe + '?aggregate=' + aggregate + '&limit=' + limit;
            const res = await fetch(url);
            if (!res.ok) throw new Error('OHLCV fetch failed');
            return res.json();
        }

        async function tvLoadChart(poolAddress, timeframe, aggregate, limit, btn) {
            if (poolAddress) tvCurrentPool = poolAddress;
            if (timeframe) tvCurrentTf = timeframe;
            if (aggregate) tvCurrentAgg = aggregate;
            if (limit) tvCurrentLimit = limit;

            if (btn) {
                document.querySelectorAll('.tv-tf-buttons .btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            const loading = document.getElementById('tvLoading');
            loading.style.display = 'flex';

            try {
                const data = await tvFetchOHLCV(tvCurrentPool, tvCurrentTf, tvCurrentAgg, tvCurrentLimit);
                const ohlcv = data.data.attributes.ohlcv_list;
                const meta = data.meta;

                const baseSymbol = meta.base.symbol || '?';
                const quoteSymbol = meta.quote.symbol || '?';
                const modeLabel = tvMode === 'mcap' ? ' (MCap)' : '';
                document.getElementById('tvPairLabel').textContent =
                    baseSymbol + ' / ' + quoteSymbol + modeLabel;

                let multiplier = 1;
                if (tvMode === 'mcap') {
                    const info = await tvFetchPoolInfo(tvCurrentPool);
                    multiplier = info.supply > 0 ? info.supply : 1;
                }

                const candles = ohlcv.map(d => ({
                    time: d[0],
                    open: parseFloat(d[1]) * multiplier,
                    high: parseFloat(d[2]) * multiplier,
                    low: parseFloat(d[3]) * multiplier,
                    close: parseFloat(d[4]) * multiplier
                })).sort((a, b) => a.time - b.time);

                const volumes = ohlcv.map(d => ({
                    time: d[0],
                    value: parseFloat(d[5]),
                    color: parseFloat(d[4]) >= parseFloat(d[1]) ? 'rgba(0,170,0,0.3)' : 'rgba(204,0,0,0.3)'
                })).sort((a, b) => a.time - b.time);

                tvCandleSeries.setData(candles);
                tvVolumeSeries.setData(volumes);
                tvChart.timeScale().fitContent();
            } catch (e) {
                console.error('Chart load error:', e);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function tvSearchPools(query) {
            if (!query || query.length < 2) return [];
            const url = 'https://api.geckoterminal.com/api/v2/search/pools?query=' +
                encodeURIComponent(query) + '&network=solana&page=1';
            const res = await fetch(url);
            if (!res.ok) return [];
            const data = await res.json();
            return (data.data || []).slice(0, 8).map(p => ({
                name: p.attributes.name,
                address: p.attributes.address,
                price: p.attributes.base_token_price_usd,
                dex: (p.relationships && p.relationships.dex && p.relationships.dex.data)
                    ? p.relationships.dex.data.id : ''
            }));
        }

        (function tvSetupSearch() {
            const input = document.getElementById('tvSearchInput');
            const results = document.getElementById('tvSearchResults');

            input.addEventListener('input', function() {
                clearTimeout(tvSearchTimeout);
                const q = this.value.trim();
                if (q.length < 2) { results.classList.remove('open'); return; }
                tvSearchTimeout = setTimeout(async () => {
                    const pools = await tvSearchPools(q);
                    if (pools.length === 0) { results.classList.remove('open'); return; }
                    results.innerHTML = pools.map(p =>
                        '<div class="tv-search-item" data-pool="' + p.address + '">' +
                        '<div class="pair-name">' + p.name + '</div>' +
                        '<div class="pair-meta">' + (p.dex || '') + ' · $' +
                        (p.price ? parseFloat(p.price).toPrecision(4) : '?') + '</div></div>'
                    ).join('');
                    results.classList.add('open');
                }, 350);
            });

            results.addEventListener('click', function(e) {
                const item = e.target.closest('.tv-search-item');
                if (!item) return;
                const pool = item.dataset.pool;
                input.value = item.querySelector('.pair-name').textContent;
                results.classList.remove('open');
                tvLoadChart(pool, null, null, null, null);
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tv-search-wrap')) results.classList.remove('open');
            });
        })();

        if (typeof LightweightCharts !== 'undefined') {
            tvInitChart();
        } else {
            window.addEventListener('load', function() {
                if (typeof LightweightCharts !== 'undefined') tvInitChart();
            });
        }

        // --- D3.js P&L Performance Chart ---
        function generatePnlData(range) {
            const days = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365 }[range] || 30;
            const data = [];
            const now = new Date();
            let cumPnl = 0;
            for (let i = days; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                d.setHours(0, 0, 0, 0);
                const daily = (Math.random() - 0.42) * 800;
                cumPnl += daily;
                data.push({ date: d, pnl: Math.round(cumPnl * 100) / 100 });
            }
            return data;
        }

        function renderPnlChart(range, btnEl) {
            if (btnEl) {
                document.querySelectorAll('.pnl-chart-filters .btn').forEach(b => b.classList.remove('active'));
                btnEl.classList.add('active');
            }

            const container = document.getElementById('pnlChart');
            if (!container || typeof d3 === 'undefined') return;
            container.innerHTML = '';

            const data = generatePnlData(range);
            const cw = container.clientWidth || 600;
            const marginTop = 20, marginRight = 20, marginBottom = 30, marginLeft = 55;
            const width = cw - 8;
            const height = 260;

            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([marginLeft, width - marginRight]);

            const yExt = d3.extent(data, d => d.pnl);
            const yPad = (yExt[1] - yExt[0]) * 0.1 || 100;
            const y = d3.scaleLinear()
                .domain([yExt[0] - yPad, yExt[1] + yPad])
                .range([height - marginBottom, marginTop]);

            const line = d3.line()
                .curve(d3.curveCatmullRom)
                .x(d => x(d.date))
                .y(d => y(d.pnl));

            const svg = d3.select(container).append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // Zero line
            if (yExt[0] < 0 && yExt[1] > 0) {
                svg.append('line')
                    .attr('x1', marginLeft).attr('x2', width - marginRight)
                    .attr('y1', y(0)).attr('y2', y(0))
                    .attr('stroke', '#cccccc').attr('stroke-dasharray', '4,3');
            }

            // Grid lines
            svg.append('g')
                .attr('transform', 'translate(0,' + (height - marginBottom) + ')')
                .call(d3.axisBottom(x).ticks(6).tickSize(0).tickFormat(d3.timeFormat('%-b %-d')))
                .call(g => g.select('.domain').remove())
                .selectAll('text').style('fill', '#666666').style('font-size', '8px');

            svg.append('g')
                .attr('transform', 'translate(' + marginLeft + ',0)')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => (d >= 0 ? '+' : '') + d3.format(',.0f')(d)).tickSize(0))
                .call(g => g.select('.domain').remove())
                .call(g => g.selectAll('.tick line').clone()
                    .attr('x2', width - marginLeft - marginRight)
                    .attr('stroke', '#eeeeee'))
                .selectAll('text').style('fill', '#666666').style('font-size', '8px');

            // Monochromatic gradient: map P&L range to #080808 → #444444 → #888888 → #bbbbbb
            const pnlColorScale = d3.scaleLinear()
                .domain([yExt[0], yExt[0] + (yExt[1] - yExt[0]) * 0.33, yExt[0] + (yExt[1] - yExt[0]) * 0.66, yExt[1]])
                .range(['#bbbbbb', '#888888', '#444444', '#080808'])
                .clamp(true);

            // Gradient definition for the line
            const gradId = 'pnlGrad-' + range;
            const defs = svg.append('defs');
            const grad = defs.append('linearGradient')
                .attr('id', gradId)
                .attr('gradientUnits', 'userSpaceOnUse')
                .attr('x1', marginLeft).attr('x2', width - marginRight);

            const stops = [0, 0.25, 0.5, 0.75, 1];
            stops.forEach(t => {
                const idx = Math.round(t * (data.length - 1));
                grad.append('stop').attr('offset', t).attr('stop-color', pnlColorScale(data[idx].pnl));
            });

            // Animated path
            const path = svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', 'url(#' + gradId + ')')
                .attr('stroke-width', 2)
                .attr('stroke-linejoin', 'round')
                .attr('stroke-linecap', 'round')
                .attr('d', line);

            const totalLen = path.node().getTotalLength();
            path.attr('stroke-dasharray', totalLen + ',' + totalLen)
                .attr('stroke-dashoffset', totalLen)
                .transition().duration(2000).ease(d3.easeLinear)
                .attr('stroke-dashoffset', 0);

            // Dots
            const step = Math.max(1, Math.floor(data.length / 15));
            const keyPoints = data.filter((_, i) => i % step === 0 || i === data.length - 1);

            svg.append('g')
                .selectAll('circle')
                .data(keyPoints)
                .join('circle')
                .attr('cx', d => x(d.date))
                .attr('cy', d => y(d.pnl))
                .attr('r', 3)
                .attr('fill', '#ffffff')
                .attr('stroke', d => pnlColorScale(d.pnl))
                .attr('stroke-width', 1.5)
                .attr('opacity', 0)
                .transition()
                .delay((d, i) => (i / keyPoints.length) * 2000)
                .attr('opacity', 1);

            // End label
            const last = data[data.length - 1];
            svg.append('text')
                .attr('x', x(last.date))
                .attr('y', y(last.pnl) - 8)
                .attr('text-anchor', 'end')
                .attr('fill', pnlColorScale(last.pnl))
                .attr('font-size', '10px')
                .attr('font-weight', 'bold')
                .attr('opacity', 0)
                .text((last.pnl >= 0 ? '+$' : '-$') + Math.abs(last.pnl).toLocaleString())
                .transition().delay(2000).attr('opacity', 1);
        }

        renderPnlChart('1M', null);

        // --- D3.js Agent Performance Grouped Bar Chart ---
        (function renderAgentPerfChart() {
            const container = document.getElementById('agentPerfChart');
            if (!container || typeof d3 === 'undefined') return;
            const tooltip = document.getElementById('agentPerfTooltip');

            const agents = ['Momentum', 'Risk', 'Mean Rev', 'Sentiment', 'Arbitrage'];
            const timeframes = ['1W', '1M', '3M', '6M'];

            const baseRates = { Momentum: 68, Risk: 72, 'Mean Rev': 65, Sentiment: 58, Arbitrage: 75 };
            const tfAdj = { '1W': -5, '1M': 0, '3M': 3, '6M': 5 };

            const data = agents.map(agent => {
                const row = { agent };
                timeframes.forEach(tf => {
                    const base = baseRates[agent] + tfAdj[tf];
                    row[tf] = Math.round(Math.max(50, Math.min(85, base + (Math.random() * 8 - 4))) * 10) / 10;
                });
                return row;
            });

            const margin = { top: 20, right: 10, bottom: 30, left: 40 };
            const containerWidth = container.clientWidth || 928;
            const width = containerWidth - 16;
            const height = 260;

            const fx = d3.scaleBand()
                .domain(agents)
                .rangeRound([margin.left, width - margin.right])
                .paddingInner(0.2);

            const x = d3.scaleBand()
                .domain(timeframes)
                .rangeRound([0, fx.bandwidth()])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([40, 90])
                .nice()
                .rangeRound([height - margin.bottom, margin.top]);

            const barColors = { '1W': '#080808', '1M': '#444444', '3M': '#888888', '6M': '#bbbbbb' };

            const svg = d3.select(container).append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // Grid lines
            svg.append('g')
                .attr('transform', 'translate(' + margin.left + ',0)')
                .call(d3.axisLeft(y).ticks(5).tickSize(-(width - margin.left - margin.right)).tickFormat(''))
                .call(g => g.select('.domain').remove())
                .call(g => g.selectAll('.tick line').attr('stroke', '#cccccc').attr('stroke-opacity', 0.4));

            // Bars
            const groups = svg.append('g')
                .selectAll('g')
                .data(data)
                .join('g')
                .attr('transform', d => 'translate(' + fx(d.agent) + ',0)');

            groups.selectAll('rect')
                .data(d => timeframes.map(tf => ({ agent: d.agent, tf, value: d[tf] })))
                .join('rect')
                .attr('x', d => x(d.tf))
                .attr('width', x.bandwidth())
                .attr('y', height - margin.bottom)
                .attr('height', 0)
                .attr('fill', d => barColors[d.tf])
                .attr('rx', 2)
                .on('mouseenter', function(event, d) {
                    d3.select(this).attr('opacity', 0.75);
                    tooltip.style.opacity = '1';
                    tooltip.innerHTML = '<strong>' + d.agent + '</strong><br>' + d.tf + ': ' + d.value + '% win rate';
                })
                .on('mousemove', function(event) {
                    tooltip.style.left = (event.clientX + 12) + 'px';
                    tooltip.style.top = (event.clientY - 10) + 'px';
                })
                .on('mouseleave', function() {
                    d3.select(this).attr('opacity', 1);
                    tooltip.style.opacity = '0';
                })
                .transition()
                .duration(600)
                .delay((d, i) => i * 80)
                .attr('y', d => y(d.value))
                .attr('height', d => y(40) - y(d.value));

            // X axis
            svg.append('g')
                .attr('transform', 'translate(0,' + (height - margin.bottom) + ')')
                .call(d3.axisBottom(fx).tickSizeOuter(0).tickSize(0))
                .call(g => g.select('.domain').remove())
                .selectAll('text')
                .style('font-size', '9px')
                .style('font-family', "'Alliance No.2', sans-serif")
                .style('fill', '#666666');

            // Y axis
            svg.append('g')
                .attr('transform', 'translate(' + margin.left + ',0)')
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => d + '%'))
                .call(g => g.select('.domain').remove())
                .selectAll('text')
                .style('font-size', '9px')
                .style('font-family', "'Alliance No.2', sans-serif")
                .style('fill', '#666666');

            // Legend
            const legend = svg.append('g')
                .attr('transform', 'translate(' + (width - margin.right - timeframes.length * 50) + ',' + 8 + ')');

            timeframes.forEach((tf, i) => {
                const g = legend.append('g').attr('transform', 'translate(' + (i * 50) + ',0)');
                g.append('rect').attr('width', 10).attr('height', 10).attr('rx', 1).attr('fill', barColors[tf]);
                g.append('text').attr('x', 13).attr('y', 9).text(tf).style('font-size', '8px').style('font-family', "'Alliance No.2', sans-serif").style('fill', '#666666');
            });
        })();

        // --- D3.js API Usage Heatmap ---
        (function renderApiHeatmap() {
            const container = document.getElementById('apiHeatmap');
            if (!container || typeof d3 === 'undefined') return;

            // Generate 30 days of mock hourly API usage data
            const now = new Date();
            const data = [];
            for (let d = 29; d >= 0; d--) {
                const day = new Date(now);
                day.setDate(day.getDate() - d);
                day.setHours(0, 0, 0, 0);
                for (let h = 0; h < 24; h++) {
                    const base = Math.sin((h - 14) * 0.3) * 30 + 50;
                    const noise = Math.random() * 40 - 20;
                    const weekday = day.getDay();
                    const weekendFactor = (weekday === 0 || weekday === 6) ? 0.6 : 1;
                    data.push({
                        date: new Date(day),
                        hour: h,
                        usage: Math.max(0, Math.round((base + noise) * weekendFactor))
                    });
                }
            }

            const margin = { top: 50, right: 10, bottom: 10, left: 25 };
            const days = [...new Set(data.map(d => d.date.getTime()))].map(t => new Date(t));
            const containerWidth = container.clientWidth || 600;
            const width = containerWidth - 16;
            const cellW = (width - margin.left - margin.right) / 24;
            const cellH = Math.max(cellW * 0.55, 10);
            const height = margin.top + margin.bottom + days.length * cellH;
            const maxUsage = d3.max(data, d => d.usage);

            const x = d3.scaleBand()
                .domain(d3.range(24))
                .range([margin.left, width - margin.right])
                .padding(0.05);

            const y = d3.scaleBand()
                .domain(days.map(d => d.getTime()))
                .range([margin.top, height - margin.bottom])
                .padding(0.05);

            const color = d3.scaleSequential([0, maxUsage], d3.interpolateGreys);

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height]);

            // X axis — hours
            const formatHour = d => d === 0 ? '12a' : d === 12 ? '12p' : (d % 12) + (d < 12 ? 'a' : 'p');
            svg.append('g')
                .attr('transform', 'translate(0,' + margin.top + ')')
                .call(d3.axisTop(x).tickFormat(formatHour).tickSize(0))
                .call(g => g.select('.domain').remove())
                .selectAll('text')
                .style('font-size', '7px')
                .style('fill', '#666666');

            // Y axis — days
            const formatMonth = d3.timeFormat('%b %-d');
            const formatDate = d3.timeFormat('%-d');
            const formatDay = d => (d.getDate() === 1 ? formatMonth : formatDate)(d);

            svg.append('g')
                .attr('transform', 'translate(' + margin.left + ',0)')
                .call(d3.axisLeft(y).tickFormat(t => formatDay(new Date(t))).tickSize(0))
                .call(g => g.select('.domain').remove())
                .selectAll('text')
                .style('font-size', '7px')
                .style('fill', '#666666');

            // Tooltip
            const tooltip = document.getElementById('apiTooltip');

            // Cells
            svg.append('g')
                .selectAll('rect')
                .data(data)
                .join('rect')
                .attr('x', d => x(d.hour))
                .attr('y', d => y(d.date.getTime()))
                .attr('width', x.bandwidth())
                .attr('height', y.bandwidth())
                .attr('fill', d => d.usage === 0 ? '#f8f8f8' : color(d.usage))
                .attr('rx', 1)
                .on('mouseover', function(event, d) {
                    tooltip.style.opacity = '1';
                    const dayStr = d3.timeFormat('%b %d')(d.date);
                    tooltip.textContent = dayStr + ' ' + formatHour(d.hour) + ' — ' + d.usage + ' calls';
                })
                .on('mousemove', function(event) {
                    tooltip.style.left = (event.clientX + 10) + 'px';
                    tooltip.style.top = (event.clientY - 28) + 'px';
                })
                .on('mouseout', function() {
                    tooltip.style.opacity = '0';
                });

            // Legend gradient on canvas
            const canvas = document.getElementById('apiLegendBar');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                for (let i = 0; i < w; i++) {
                    ctx.fillStyle = color((i / w) * maxUsage);
                    ctx.fillRect(i, 0, 1, h);
                }
            }
        })();



        // --- Live Ticker Tape (CoinGecko) ---
        const TICKER_COINS = [
            { id: 'solana', pair: 'SOL/USDC' },
            { id: 'bitcoin', pair: 'BTC/USDC' },
            { id: 'ethereum', pair: 'ETH/USDC' },
            { id: 'raydium', pair: 'RAY/USDC' },
            { id: 'jupiter-exchange-solana', pair: 'JUP/USDC' },
            { id: 'drift-protocol', pair: 'DRIFT/USDC' },
        ];

        function formatTickerPrice(price) {
            if (price >= 1000) return '$' + price.toLocaleString('en-US', { maximumFractionDigits: 0 });
            if (price >= 1) return '$' + price.toFixed(2);
            if (price >= 0.01) return '$' + price.toFixed(4);
            return '$' + price.toFixed(6);
        }

        function renderTickerItems(data) {
            const el = document.getElementById('tickerContent');
            if (!el || !data) return;
            const items = TICKER_COINS.map(coin => {
                const d = data[coin.id];
                if (!d) return '';
                const price = formatTickerPrice(d.usd);
                const change = d.usd_24h_change || 0;
                const dir = change >= 0 ? 'up' : 'down';
                const sign = change >= 0 ? '+' : '';
                return '<span class="ticker-item">' + coin.pair +
                    ' <span class="price">' + price + '</span>' +
                    ' <span class="change ' + dir + '">' + sign + change.toFixed(2) + '%</span></span>';
            }).join('');
            el.innerHTML = items + items;
        }

        async function fetchTickerPrices() {
            try {
                const ids = TICKER_COINS.map(c => c.id).join(',');
                const key = (typeof CORTEX_CONFIG !== 'undefined' && CORTEX_CONFIG.COINGECKO_API_KEY) || '';
                const url = 'https://api.coingecko.com/api/v3/simple/price?ids=' + ids +
                    '&vs_currencies=usd&include_24hr_change=true' +
                    (key ? '&x_cg_demo_api_key=' + key : '');
                const res = await fetch(url);
                if (!res.ok) throw new Error('CoinGecko HTTP ' + res.status);
                const data = await res.json();
                renderTickerItems(data);
                console.log('[TICKER] Live prices updated');
            } catch (e) {
                console.warn('[TICKER] Fetch error:', e.message);
            }
        }

        fetchTickerPrices();
        setInterval(fetchTickerPrices, 30000);

        startNewsRefresh();
        startRegimeDetection();
        startGuardianService();

        console.log('CORTEX Dashboard initialized');
        console.log('TX Feed: Active');
        console.log('Guardian: Live API connected');
    </script>

    <script>
    // === AGENT SIGNAL CLUSTERING — ecStat K-Means ===
    (function () {
        const el = document.getElementById('agentClusterChart');
        if (!el || typeof echarts === 'undefined' || typeof ecStat === 'undefined') return;
        echarts.registerTransform(ecStat.transform.clustering);

        const data = [
            [3.275,2.958],[-3.344,2.604],[0.355,-3.377],[1.852,3.547],[-2.079,2.552],
            [-0.994,-0.884],[2.682,4.008],[-3.088,2.879],[-1.566,-1.257],[2.442,0.445],
            [-0.659,3.111],[-0.460,-2.618],[2.178,2.388],[-2.921,2.917],[-0.029,-4.168],
            [3.626,2.119],[-3.912,1.325],[-0.552,-2.814],[2.856,3.483],[-3.594,2.857],
            [0.422,-2.373],[1.651,3.408],[-2.083,3.384],[-0.719,-2.493],[4.514,3.841],
            [-4.822,4.607],[-0.656,-1.450],[1.920,4.439],[-3.288,3.919],[-1.577,-2.978],
            [3.598,1.976],[-3.977,4.901],[-1.791,-2.185],[3.915,3.559],[-1.910,4.167],
            [-1.227,-3.318],[1.149,3.345],[-2.114,3.548],[0.846,-3.590],[2.629,3.536],
            [-1.641,2.991],[-1.881,-2.485],[4.607,3.510],[-4.366,4.023],[0.765,-3.001],
            [3.122,2.174],[-4.025,4.652],[-0.560,-3.841],[4.377,4.864],[-1.874,4.032],
            [-0.089,-3.027],[3.998,2.519],[-3.083,2.885],[0.845,-3.454],[1.327,3.359],
            [-2.890,3.596],[-0.966,-2.840],[2.961,3.080],[-3.276,1.577],[0.639,-3.413]
        ];

        const CLUSTER_COUNT = 6;
        const DIM_CLUSTER = 2;
        const PASTEL = ['#a8d8ea','#f6c6a8','#c3b1e1','#b5e6b5','#f9d5e5','#ffe0ac'];
        const LABELS = ['Momentum','Mean Rev','Sentiment','Risk','Arbitrage','Execution'];

        const pieces = LABELS.map(function (name, i) {
            return { value: i, label: name, color: PASTEL[i] };
        });

        const fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-mono').trim() || 'sans-serif';

        const chart = echarts.init(el);
        chart.setOption({
            dataset: [
                { source: data },
                {
                    transform: {
                        type: 'ecStat:clustering',
                        config: { clusterCount: CLUSTER_COUNT, outputType: 'single', outputClusterIndexDimension: DIM_CLUSTER }
                    }
                }
            ],
            backgroundColor: 'transparent',
            textStyle: { fontFamily },
            tooltip: {
                trigger: 'item',
                backgroundColor: '#080808',
                borderColor: '#080808',
                textStyle: { color: '#fff', fontFamily, fontSize: 11 },
                formatter: function (p) {
                    var ci = p.value[DIM_CLUSTER];
                    return (LABELS[ci] || 'Cluster ' + ci) + '<br>Confidence: ' + p.value[0].toFixed(2) + '<br>Signal Strength: ' + p.value[1].toFixed(2);
                }
            },
            visualMap: {
                type: 'piecewise',
                top: 'middle',
                min: 0,
                max: CLUSTER_COUNT,
                left: 10,
                splitNumber: CLUSTER_COUNT,
                dimension: DIM_CLUSTER,
                pieces: pieces,
                textStyle: { fontFamily, fontSize: 10, color: '#222' }
            },
            grid: { left: 120, right: 20, top: 20, bottom: 30 },
            xAxis: { name: 'Confidence', nameTextStyle: { fontFamily, fontSize: 10, color: '#222' }, axisLine: { lineStyle: { color: '#000' } }, splitLine: { lineStyle: { color: '#eee' } }, axisLabel: { fontSize: 10, color: '#222' } },
            yAxis: { name: 'Signal Strength', nameTextStyle: { fontFamily, fontSize: 10, color: '#222' }, axisLine: { lineStyle: { color: '#000' } }, splitLine: { lineStyle: { color: '#eee' } }, axisLabel: { fontSize: 10, color: '#222' } },
            series: {
                type: 'scatter',
                encode: { tooltip: [0, 1] },
                symbolSize: 10,
                itemStyle: { borderColor: '#ccc', borderWidth: 1 },
                datasetIndex: 1
            }
        });

        window.addEventListener('resize', function () { chart.resize(); });
    })();
    </script>
    <script src="js/toast.js"></script>
</body>
</html>