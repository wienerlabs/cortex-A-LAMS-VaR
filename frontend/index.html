<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cortex Risk Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --font:'Space Grotesk',system-ui,sans-serif;
  --bg:#fafafa;--fg:#111;--surface:#fff;--border:#d0d0d0;
  --muted:#666;--subtle:#f0f0f0;
  --accent:#6366f1;--accent-fg:#fff;
  --success:#16a34a;--success-bg:#f0fdf4;
  --error:#dc2626;--error-bg:#fef2f2;
  --warning:#d97706;--warning-bg:#fffbeb;
  --radius:6px;--gap:8px;
  --shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
  --shadow-lg:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(0,0,0,.06);
}
@media(prefers-color-scheme:dark){
  :root{
    --bg:#0a0a0a;--fg:#e5e5e5;--surface:#161616;--border:#2a2a2a;
    --muted:#999;--subtle:#1a1a1a;
    --accent:#818cf8;--accent-fg:#111;
    --success:#22c55e;--success-bg:#052e16;
    --error:#ef4444;--error-bg:#450a0a;
    --warning:#f59e0b;--warning-bg:#451a03;
    --shadow:0 1px 3px rgba(0,0,0,.3),0 1px 2px rgba(0,0,0,.2);
    --shadow-lg:0 4px 12px rgba(0,0,0,.4),0 2px 4px rgba(0,0,0,.3);
  }
}
@media(prefers-reduced-motion:reduce){*{transition:none!important;animation:none!important}}
html{font-family:var(--font);font-size:15px;color:var(--fg);background:var(--bg)}
body{max-width:1024px;margin:0 auto;padding:24px 16px;padding-top:72px}
/* Header */
header{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--surface);border-bottom:1px solid var(--border);box-shadow:var(--shadow);padding:0 16px}
header .inner{max-width:1024px;margin:0 auto;display:flex;align-items:center;gap:16px;height:56px}
header h1{font-size:1.1rem;font-weight:700;letter-spacing:-.02em;white-space:nowrap}
header h1 span{color:var(--accent)}
#health-status{font-size:.72rem;padding:3px 8px;border-radius:12px;white-space:nowrap;font-weight:600}
#health-status.ok{background:var(--success-bg);color:var(--success);border:1px solid var(--success)}
#health-status.err{background:var(--error-bg);color:var(--error);border:1px solid var(--error)}
#health-status.loading{background:var(--subtle);color:var(--muted);border:1px solid var(--border)}
/* Calibration tracker */
#cal-tracker{font-size:.72rem;color:var(--muted);margin-left:auto;display:flex;align-items:center;gap:6px}
#cal-tracker .badge{background:var(--accent);color:var(--accent-fg);padding:2px 8px;border-radius:10px;font-weight:600;font-size:.68rem}
/* Nav */
nav{position:sticky;top:56px;z-index:90;background:var(--bg);border-bottom:1px solid var(--border);padding:8px 0;margin:-8px -16px 24px;padding-left:16px;padding-right:16px;display:flex;flex-wrap:wrap;gap:4px;overflow-x:auto}
nav a{font-size:.72rem;color:var(--muted);text-decoration:none;border:1px solid transparent;padding:4px 10px;border-radius:12px;transition:background .15s,color .15s,border-color .15s;white-space:nowrap}
nav a:hover{background:var(--subtle);color:var(--fg);border-color:var(--border)}
nav a.active{background:var(--accent);color:var(--accent-fg);border-color:var(--accent);font-weight:600}
nav a:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
/* Sections */
h2{font-size:1.1rem;font-weight:700;margin:32px 0 8px;display:flex;align-items:center;gap:8px}
h2 .badge{font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:600;background:var(--subtle);color:var(--muted);border:1px solid var(--border)}
p.desc{font-size:.78rem;color:var(--muted);margin-bottom:12px;line-height:1.5}
.section{margin-bottom:40px}
/* Endpoints */
.endpoint{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;margin-bottom:8px;box-shadow:var(--shadow);transition:box-shadow .15s}
.endpoint:hover{box-shadow:var(--shadow-lg)}
.endpoint summary{cursor:pointer;font-weight:600;font-size:.85rem;list-style:none;display:flex;align-items:center;gap:8px}
.endpoint summary::before{content:'▸';font-size:.7rem;color:var(--muted);transition:transform .15s}
.endpoint[open] summary::before{transform:rotate(90deg)}
.endpoint summary .method{font-size:.65rem;padding:2px 8px;border-radius:3px;font-weight:700;letter-spacing:.04em;background:var(--subtle);color:var(--fg);border:1px solid var(--border)}
.endpoint summary .method.post{background:var(--accent);color:var(--accent-fg);border-color:var(--accent)}
.endpoint.primary{border-color:var(--accent);border-width:2px;background:color-mix(in srgb,var(--accent) 3%,var(--surface))}
.endpoint.primary summary{font-size:.9rem}
/* Form grid */
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;margin-top:8px}
.form-grid .field-full{grid-column:1/-1}
label{display:block;font-size:.72rem;font-weight:600;margin-bottom:2px;color:var(--muted);text-transform:uppercase;letter-spacing:.03em}
input,select,textarea{font-family:var(--font);font-size:.82rem;border:1px solid var(--border);border-radius:var(--radius);padding:7px 10px;width:100%;background:var(--bg);color:var(--fg);transition:border-color .15s}
input:focus-visible,select:focus-visible,textarea:focus-visible{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 20%,transparent)}
button:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
textarea{min-height:56px;resize:vertical}
/* Buttons */
.btn-row{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
button{font-family:var(--font);font-size:.8rem;font-weight:600;padding:8px 20px;border:none;border-radius:var(--radius);cursor:pointer;transition:opacity .1s,transform .05s}
button:hover{opacity:.9}
button:active{transform:scale(.98)}
button:disabled{opacity:.4;cursor:not-allowed;transform:none}
.btn-primary{background:var(--accent);color:var(--accent-fg)}
.btn-secondary{background:var(--subtle);color:var(--fg);border:1px solid var(--border)}
.btn-copy{font-size:.7rem;padding:4px 10px;background:var(--subtle);color:var(--muted);border:1px solid var(--border);border-radius:var(--radius)}
.btn-copy.copied{background:var(--success-bg);color:var(--success);border-color:var(--success)}
/* Results */
.result-wrap{margin-top:8px;position:relative}
.result{border:1px solid var(--border);border-radius:var(--radius);max-height:400px;overflow:auto;background:var(--bg)}
.result pre{font-family:'Space Grotesk',monospace;font-size:.75rem;padding:12px;white-space:pre-wrap;word-break:break-all;line-height:1.5}
.result.ok{border-color:var(--success)}
.result.err{border-color:var(--error)}
.result-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
/* Status */
.status{font-size:.72rem;margin-top:6px;font-weight:600;display:flex;align-items:center;gap:6px}
.status.ok{color:var(--success)}
.status.err{color:var(--error)}
.status.loading{color:var(--muted)}
/* Spinner */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
</style>
</head>
<body>

<header>
  <div class="inner">
    <h1>Cortex <span>Risk Engine</span></h1>
    <div id="health-status" class="loading" role="status" aria-live="polite">Checking…</div>
    <div id="cal-tracker" aria-live="polite">Calibrated: <span id="cal-tokens">none</span></div>
  </div>
</header>

<nav id="main-nav" aria-label="Section navigation">
<a href="#msm">MSM Core</a>
<a href="#regime">Regime</a>
<a href="#news">News</a>
<a href="#compare">Compare</a>
<a href="#portfolio">Portfolio</a>
<a href="#evt">EVT</a>
<a href="#copula">Copula</a>
<a href="#hawkes">Hawkes</a>
<a href="#fractal">Fractal</a>
<a href="#rough">Rough Vol</a>
<a href="#svj">SVJ</a>
<a href="#lvar">LVaR</a>
<a href="#oracle">Oracle</a>
<a href="#social">Social</a>
<a href="#macro">Macro</a>
<a href="#streams">Streams</a>
<a href="#portrisk">Port. Risk</a>
<a href="#caltasks">Calibration</a>
<a href="#guardian">Guardian</a>
</nav>

<main id="app"></main>

<script>
const API = '/api/v1';

function el(tag, attrs, ...children) {
  const e = document.createElement(tag);
  if (attrs) Object.entries(attrs).forEach(([k,v]) => {
    if (k === 'className') e.className = v;
    else if (k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v);
    else e.setAttribute(k, v);
  });
  children.flat().forEach(c => {
    if (typeof c === 'string') e.appendChild(document.createTextNode(c));
    else if (c) e.appendChild(c);
  });
  return e;
}

function field(name, dflt, type='text', opts={}) {
  return { name, dflt: dflt ?? '', type, ...opts };
}

const SECTIONS = [
  { id:'msm', title:'MSM Core', badge:'Start Here', desc:'Calibrate MSM model and query VaR, volatility, backtest', endpoints:[
    { method:'POST', path:'/calibrate', desc:'Calibrate MSM model for a token — required before most other endpoints.', primary:true,
      fields:[
        field('token','SOL','text',{placeholder:'SOL, RAY, JUP, BONK or mint address or yfinance ticker'}),
        field('data_source','solana','select',{options:['solana','yfinance']}),
        field('start_date','2024-01-01'), field('end_date','2025-01-01'),
        field('num_states','5','number'), field('method','empirical','select',{options:['mle','grid','empirical','hybrid']}),
        field('target_var_breach','0.05','number'), field('interval','1D'),
        field('use_student_t','false','select',{options:['false','true']}), field('nu','5.0','number'),
      ]},
    { method:'GET', path:'/regime/current', desc:'Current regime state',
      fields:[field('token','SOL')]},
    { method:'GET', path:'/var/{confidence}', desc:'VaR at confidence level',
      fields:[field('confidence','95','number'), field('token','SOL'),
        field('use_student_t','','select',{options:['','false','true']}), field('nu','','number')]},
    { method:'GET', path:'/volatility/forecast', desc:'Volatility forecast',
      fields:[field('token','SOL')]},
    { method:'GET', path:'/backtest/summary', desc:'Backtest summary',
      fields:[field('token','SOL'), field('alpha','0.05','number')]},
    { method:'GET', path:'/tail-probs', desc:'Tail probabilities',
      fields:[field('token','SOL'), field('alpha','0.05','number'),
        field('use_student_t','false','select',{options:['false','true']}), field('nu','5.0','number')]},
  ]},
  { id:'regime', title:'Regime Analytics', badge:'Requires calibration', desc:'Durations, history, transitions, statistics', endpoints:[
    { method:'GET', path:'/regime/durations', fields:[field('token','SOL')]},
    { method:'GET', path:'/regime/history', fields:[field('token','SOL')]},
    { method:'GET', path:'/regime/transition-alert',
      fields:[field('token','SOL'), field('threshold','0.3','number')]},
    { method:'GET', path:'/regime/statistics', fields:[field('token','SOL')]},
  ]},
  { id:'news', title:'News Intelligence', badge:'Independent', desc:'News feed, sentiment, market signal — works without calibration', endpoints:[
    { method:'GET', path:'/news/feed',
      fields:[field('regime_state','','number'), field('max_items','50','number')]},
    { method:'GET', path:'/news/sentiment',
      fields:[field('regime_state','','number'), field('max_items','20','number')]},
    { method:'GET', path:'/news/signal', fields:[field('regime_state','','number')]},
  ]},
  { id:'compare', title:'Model Comparison', badge:'Requires calibration', desc:'Compare volatility models (GARCH, EGARCH, GJR, EWMA, rolling)', endpoints:[
    { method:'POST', path:'/compare', desc:'Run model comparison',
      fields:[field('token','SOL'), field('alpha','0.05','number'),
        field('models','','text',{placeholder:'e.g. ewma,garch (blank=all)'})]},
    { method:'GET', path:'/compare/report/{token}', desc:'Comparison report',
      fields:[field('token','SOL'), field('alpha','0.05','number')]},
  ]},
  { id:'portfolio', title:'Portfolio VaR', desc:'Multi-asset portfolio risk', endpoints:[
    { method:'POST', path:'/portfolio/calibrate', desc:'Calibrate portfolio — Solana symbols or yfinance tickers',
      fields:[field('tokens','SOL,RAY,JUP','text',{placeholder:'comma-separated: SOL,RAY,JUP or AAPL,MSFT,GOOGL'}),
        field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('num_states','5','number'), field('method','mle','select',{options:['mle','grid','empirical','hybrid']}),
        field('period','2y'), field('data_source','solana','select',{options:['solana','yfinance']}),
        field('copula_family','','select',{options:['','gaussian','student_t','clayton','gumbel','frank','auto']})]},
    { method:'POST', path:'/portfolio/var', desc:'Portfolio VaR (custom weights)',
      fields:[field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('alpha','0.05','number')]},
    { method:'POST', path:'/portfolio/marginal-var', desc:'Marginal VaR decomposition',
      fields:[field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('alpha','0.05','number')]},
    { method:'POST', path:'/portfolio/stress-var', desc:'Stressed VaR',
      fields:[field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('forced_regime','5','number'), field('alpha','0.05','number')]},
  ]},
  { id:'evt', title:'Extreme Value Theory', badge:'Requires calibration', desc:'GPD tail fitting and EVT-VaR for extreme loss modeling', endpoints:[
    { method:'POST', path:'/evt/calibrate', desc:'Fit GPD',
      fields:[field('token','SOL'),
        field('threshold_method','percentile','select',{options:['percentile','mean_excess','automated']}),
        field('min_exceedances','30','number')]},
    { method:'GET', path:'/evt/var/{confidence}', desc:'EVT VaR',
      fields:[field('confidence','99','number'), field('token','SOL')]},
    { method:'GET', path:'/evt/diagnostics', fields:[field('token','SOL')]},
  ]},
  { id:'copula', title:'Copula Portfolio', badge:'Requires portfolio', desc:'Copula-based portfolio VaR with dependency modeling', endpoints:[
    { method:'POST', path:'/portfolio/copula/var', desc:'Copula VaR',
      fields:[field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('alpha','0.05','number'), field('n_simulations','10000','number')]},
    { method:'GET', path:'/portfolio/copula/diagnostics', desc:'Copula diagnostics', fields:[]},
    { method:'POST', path:'/portfolio/copula/compare', desc:'Compare copula families', fields:[]},
    { method:'POST', path:'/portfolio/copula/regime-var', desc:'Regime-dependent copula VaR',
      fields:[field('weights','{"SOL":0.4,"RAY":0.3,"JUP":0.3}','textarea',{full:true}),
        field('alpha','0.05','number'), field('n_simulations','10000','number')]},
  ]},
  { id:'hawkes', title:'Hawkes Process', badge:'Requires calibration', desc:'Self-exciting crash clustering — models how crashes trigger more crashes', endpoints:[
    { method:'POST', path:'/hawkes/calibrate', desc:'Fit Hawkes process',
      fields:[field('token','SOL'), field('threshold_percentile','95','number'),
        field('use_absolute','true','select',{options:['true','false']})]},
    { method:'GET', path:'/hawkes/intensity', fields:[field('token','SOL')]},
    { method:'GET', path:'/hawkes/clusters', fields:[field('token','SOL')]},
    { method:'POST', path:'/hawkes/var', desc:'Hawkes-adjusted VaR',
      fields:[field('token','SOL'), field('confidence','95','number'),
        field('max_multiplier','3.0','number')]},
    { method:'POST', path:'/hawkes/simulate', desc:'Simulate Hawkes process',
      fields:[field('token','SOL'), field('mu','','number'), field('alpha','','number'),
        field('beta','','number'), field('T','500','number'), field('seed','42','number')]},
  ]},
  { id:'fractal', title:'Multifractal Analysis', badge:'Requires calibration', desc:'Hurst exponent and fractal diagnostics — market memory analysis', endpoints:[
    { method:'GET', path:'/fractal/hurst',
      fields:[field('token','SOL'), field('method','rs','select',{options:['rs','dfa']})]},
    { method:'GET', path:'/fractal/spectrum', fields:[field('token','SOL')]},
    { method:'GET', path:'/fractal/regime-hurst', fields:[field('token','SOL')]},
    { method:'GET', path:'/fractal/diagnostics', fields:[field('token','SOL')]},
  ]},
  { id:'rough', title:'Rough Volatility', badge:'Requires calibration', desc:'rBergomi / rHeston models — captures short-term vol roughness', endpoints:[
    { method:'POST', path:'/rough/calibrate', desc:'Calibrate rough vol model',
      fields:[field('token','SOL'),
        field('model','rough_bergomi','select',{options:['rough_bergomi','rough_heston']}),
        field('window','5','number'), field('max_lag','50','number')]},
    { method:'GET', path:'/rough/forecast',
      fields:[field('token','SOL'), field('horizon','10','number'), field('n_paths','500','number')]},
    { method:'GET', path:'/rough/diagnostics',
      fields:[field('token','SOL'), field('window','5','number'), field('max_lag','50','number')]},
    { method:'GET', path:'/rough/compare-msm', fields:[field('token','SOL')]},
  ]},
  { id:'svj', title:'SVJ Model', badge:'Requires calibration', desc:'Stochastic Volatility with Jumps — models sudden price jumps', endpoints:[
    { method:'POST', path:'/svj/calibrate',
      fields:[field('token','SOL'),
        field('use_hawkes','false','select',{options:['false','true']}),
        field('jump_threshold_multiplier','3.0','number')]},
    { method:'GET', path:'/svj/var',
      fields:[field('token','SOL'), field('alpha','0.05','number'),
        field('n_simulations','50000','number')]},
    { method:'GET', path:'/svj/jump-risk', fields:[field('token','SOL')]},
    { method:'GET', path:'/svj/diagnostics', fields:[field('token','SOL')]},
  ]},
  { id:'lvar', title:'Liquidity-Adjusted VaR', badge:'Requires calibration', desc:'LVaR — adds bid-ask spread and market impact costs to VaR', endpoints:[
    { method:'POST', path:'/lvar/estimate', desc:'Compute LVaR with spread estimation',
      fields:[field('token','SOL'), field('confidence','95','number'),
        field('position_value','100000','number'), field('holding_period','1','number'),
        field('window','','number')]},
    { method:'GET', path:'/lvar/regime-var', desc:'Regime-aware LVaR',
      fields:[field('token','SOL'), field('confidence','95','number'),
        field('position_value','100000','number'), field('holding_period','1','number')]},
    { method:'POST', path:'/lvar/impact', desc:'Market impact cost estimation',
      fields:[field('token','SOL'), field('trade_size_usd','50000','number'),
        field('adv_usd','1000000','number'), field('participation_rate','0.1','number')]},
    { method:'GET', path:'/lvar/regime-profile', desc:'Regime liquidity profile',
      fields:[field('token','SOL')]},
  ]},
  { id:'oracle', title:'Pyth Oracle', badge:'Independent', desc:'Live Pyth Network price feeds — 585+ crypto assets, no calibration needed', endpoints:[
    { method:'GET', path:'/oracle/feeds', desc:'List all available feeds',
      fields:[field('query','','text',{placeholder:'Filter: SOL, bitcoin, etc.'}),
        field('asset_type','crypto')]},
    { method:'GET', path:'/oracle/search', desc:'Search feeds by name',
      fields:[field('q','SOL','text',{placeholder:'SOL, ethereum, BONK...'})]},
    { method:'GET', path:'/oracle/prices', desc:'Fetch live prices',
      fields:[field('symbols','SOL,BTC,ETH','text',{placeholder:'Comma-separated: SOL,BTC,ETH'}),
        field('ids','','text',{placeholder:'Or Pyth feed IDs (hex)'})]},
    { method:'GET', path:'/oracle/history', desc:'Historical prices at a timestamp',
      fields:[field('timestamp','','number'), field('symbols','SOL,BTC','text',{placeholder:'SOL,BTC'})]},
    { method:'GET', path:'/oracle/buffer', desc:'Price ring-buffer for a feed',
      fields:[field('feed_id','','text',{placeholder:'Pyth feed ID'})]},
    { method:'GET', path:'/oracle/status', desc:'Oracle subsystem health', fields:[]},
  ]},
  { id:'social', title:'Social Sentiment', badge:'Independent', desc:'Aggregated social media sentiment analysis', endpoints:[
    { method:'GET', path:'/social/sentiment', desc:'Social sentiment for a token',
      fields:[field('token','solana','text',{placeholder:'Token or topic'})]},
  ]},
  { id:'macro', title:'Macro Indicators', badge:'Independent', desc:'Fear/Greed index, BTC dominance, market risk level', endpoints:[
    { method:'GET', path:'/macro/indicators', desc:'Current macro market indicators', fields:[]},
  ]},
  { id:'streams', title:'Transaction Streams', badge:'Independent', desc:'Helius Enhanced WebSocket — classified on-chain events', endpoints:[
    { method:'GET', path:'/streams/events', desc:'Recent classified events',
      fields:[field('limit','50','number'),
        field('severity','','select',{options:['','info','warning','critical']})]},
    { method:'GET', path:'/streams/status', desc:'Stream connection status', fields:[]},
  ]},
  { id:'portrisk', title:'Portfolio Risk Management', badge:'Live tracking', desc:'Position tracking, drawdown monitoring, and risk limit enforcement', endpoints:[
    { method:'GET', path:'/portfolio/positions', desc:'List all open positions', fields:[]},
    { method:'POST', path:'/portfolio/positions', desc:'Add or update a position',
      fields:[field('token','SOL'), field('size_usd','10000','number'),
        field('direction','long','select',{options:['long','short']}),
        field('entry_price','0','number')]},
    { method:'POST', path:'/portfolio/positions/close', desc:'Close a position and record PnL',
      fields:[field('token','SOL'), field('pnl','0','number')]},
    { method:'POST', path:'/portfolio/value', desc:'Set total portfolio value',
      fields:[field('value','100000','number')]},
    { method:'GET', path:'/portfolio/drawdown', desc:'Drawdown metrics', fields:[]},
    { method:'GET', path:'/portfolio/limits', desc:'Check risk limits for a token',
      fields:[field('token','SOL')]},
  ]},
  { id:'caltasks', title:'Calibration Tasks', badge:'Async', desc:'Poll status of long-running async calibration jobs', endpoints:[
    { method:'GET', path:'/calibrate/status/{task_id}', desc:'Get calibration task status',
      fields:[field('task_id','','text',{placeholder:'Task ID from calibrate response'})]},
  ]},
  { id:'guardian', title:'Guardian Risk Veto', badge:'Decision engine', desc:'Unified risk assessment — aggregates all models into a GO/NO-GO signal', endpoints:[
    { method:'POST', path:'/guardian/assess', desc:'Assess trade risk', primary:true,
      fields:[field('token','SOL'), field('trade_size_usd','10000','number'),
        field('direction','long','select',{options:['long','short']}),
        field('urgency','false','select',{options:['false','true']}),
        field('max_slippage_pct','1.0','number'),
        field('strategy','','select',{options:['','lp','arb','perp']}),
        field('run_debate','false','select',{options:['false','true']})]},
    { method:'GET', path:'/guardian/kelly-stats', desc:'Kelly criterion statistics', fields:[]},
    { method:'POST', path:'/guardian/trade-outcome', desc:'Record a trade outcome for Kelly tracking',
      fields:[field('pnl','0','number'), field('size','1000','number'), field('token','SOL')]},
    { method:'GET', path:'/guardian/circuit-breakers', desc:'Circuit breaker states', fields:[]},
    { method:'POST', path:'/guardian/circuit-breakers/reset', desc:'Reset circuit breakers',
      fields:[field('name','','text',{placeholder:'Breaker name (empty = reset all)'})]},
    { method:'POST', path:'/guardian/debate', desc:'Run adversarial debate (standalone)',
      fields:[field('token','SOL'), field('trade_size_usd','10000','number'),
        field('direction','long','select',{options:['long','short']}),
        field('urgency','false','select',{options:['false','true']}),
        field('max_slippage_pct','1.0','number'),
        field('strategy','','select',{options:['','lp','arb','perp']}),
        field('run_debate','true','select',{options:['false','true']})]},
  ]},
];

// Build the UI
const app = document.getElementById('app');
let eid = 0;

SECTIONS.forEach(sec => {
  const section = el('section', {className:'section', id:sec.id});
  const heading = el('h2', null, sec.title);
  if (sec.badge) heading.appendChild(el('span', {className:'badge'}, sec.badge));
  section.appendChild(heading);
  if (sec.desc) section.appendChild(el('p', {className:'desc'}, sec.desc));

  sec.endpoints.forEach(ep => {
    const uid = `ep-${eid++}`;
    const details = el('details', {className:'endpoint' + (ep.primary ? ' primary' : '')});
    if (ep.primary) details.setAttribute('open', '');
    const methodCls = 'method' + (ep.method === 'POST' ? ' post' : '');
    details.appendChild(el('summary', null,
      el('span', {className:methodCls}, ep.method),
      ` ${ep.path}`,
    ));

    if (ep.desc) details.appendChild(el('p', {className:'desc'}, ep.desc));

    const form = el('form', {id:uid, onSubmit: e => { e.preventDefault(); runEndpoint(uid, ep); }});
    const grid = el('div', {className:'form-grid'});

    ep.fields.forEach(f => {
      const id = `${uid}-${f.name}`;
      const wrapper = el('div', {className: f.full ? 'field-full' : ''});
      wrapper.appendChild(el('label', {for:id}, f.name));
      let input;
      if (f.type === 'select') {
        input = el('select', {id, name:f.name});
        (f.options||[]).forEach(o => input.appendChild(el('option', {value:o}, o || '(empty)')));
        if (f.dflt) input.value = f.dflt;
      } else if (f.type === 'textarea') {
        input = el('textarea', {id, name:f.name}, f.dflt);
      } else {
        input = el('input', {id, name:f.name, type:'text', value:f.dflt, placeholder:f.placeholder||''});
      }
      wrapper.appendChild(input);
      grid.appendChild(wrapper);
    });
    form.appendChild(grid);

    const btnRow = el('div', {className:'btn-row'});
    btnRow.appendChild(el('button', {type:'submit', className:'btn-primary'}, 'Run ▸'));
    btnRow.appendChild(el('button', {type:'button', className:'btn-secondary', onClick: () => {
      document.getElementById(`${uid}-result`).style.display = 'none';
      document.getElementById(`${uid}-result`).querySelector('pre').textContent = '';
      document.getElementById(`${uid}-result`).className = 'result';
      document.getElementById(`${uid}-status`).textContent = '';
      document.getElementById(`${uid}-status`).className = 'status';
    }}, 'Clear'));
    form.appendChild(btnRow);

    const statusEl = el('div', {className:'status', id:`${uid}-status`});
    const resultWrap = el('div', {className:'result-wrap', id:`${uid}-wrap`, style:'display:none'});
    const resultHeader = el('div', {className:'result-header'});
    const copyBtn = el('button', {type:'button', className:'btn-copy', onClick: () => {
      const text = document.getElementById(`${uid}-result`).querySelector('pre').textContent;
      navigator.clipboard.writeText(text).then(() => {
        copyBtn.textContent = '✓ Copied';
        copyBtn.classList.add('copied');
        setTimeout(() => { copyBtn.textContent = 'Copy'; copyBtn.classList.remove('copied'); }, 1500);
      });
    }}, 'Copy');
    resultHeader.appendChild(copyBtn);
    resultWrap.appendChild(resultHeader);
    const resultEl = el('div', {className:'result', id:`${uid}-result`}, el('pre', null, ''));
    resultWrap.appendChild(resultEl);
    form.appendChild(statusEl);
    form.appendChild(resultWrap);
    details.appendChild(form);
    section.appendChild(details);
  });

  app.appendChild(section);
});

// --- WebSocket Regime Streaming Panel (MSM Core section) ---
(function buildWsPanel() {
  const msmSection = document.getElementById('msm');
  if (!msmSection) return;

  let ws = null;
  let msgCount = 0;

  const panel = el('details', {className:'endpoint'});
  panel.setAttribute('open', '');
  panel.appendChild(el('summary', null,
    el('span', {className:'method'}, 'WS'),
    ' /stream/regime',
  ));
  panel.appendChild(el('p', {className:'desc'}, 'Live regime streaming via WebSocket (updates every 5s). Requires MSM calibration first.'));

  const wsForm = el('div');

  const tokenLabel = el('label', {for:'ws-token'}, 'token');
  const tokenInput = el('input', {id:'ws-token', type:'text', value:'SOL', placeholder:'SOL, RAY, JUP or ticker'});

  const statusIndicator = el('div', {className:'status', id:'ws-status'}, '● Disconnected');

  const connectBtn = el('button', {type:'button', className:'btn-primary', id:'ws-connect-btn', onClick: toggleWs}, 'Connect ▸');

  const resultBox = el('div', {className:'result', id:'ws-result', style:'display:none'},
    el('pre', null, ''));

  wsForm.appendChild(tokenLabel);
  wsForm.appendChild(tokenInput);
  wsForm.appendChild(connectBtn);
  wsForm.appendChild(statusIndicator);
  wsForm.appendChild(resultBox);
  panel.appendChild(wsForm);
  msmSection.appendChild(panel);

  function toggleWs() {
    if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
      ws.close();
    } else {
      connectWs();
    }
  }

  function connectWs() {
    const token = tokenInput.value.trim() || 'SOL';
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${proto}//${window.location.host}${API}/stream/regime?token=${encodeURIComponent(token)}`;

    statusIndicator.textContent = '● Connecting…';
    statusIndicator.className = 'status loading';
    connectBtn.disabled = true;
    tokenInput.disabled = true;
    msgCount = 0;

    ws = new WebSocket(url);

    ws.onopen = function() {
      statusIndicator.textContent = '● Connected';
      statusIndicator.className = 'status ok';
      connectBtn.textContent = 'Disconnect ■';
      connectBtn.disabled = false;
      resultBox.style.display = 'block';
      resultBox.className = 'result ok';
      resultBox.querySelector('pre').textContent = 'Waiting for data…';
    };

    ws.onmessage = function(event) {
      msgCount++;
      try {
        const data = JSON.parse(event.data);
        resultBox.querySelector('pre').textContent =
          `Message #${msgCount} — ${new Date().toLocaleTimeString()}\n` +
          JSON.stringify(data, null, 2);
      } catch {
        resultBox.querySelector('pre').textContent = event.data;
      }
    };

    ws.onerror = function() {
      statusIndicator.textContent = '● Error';
      statusIndicator.className = 'status err';
      resultBox.className = 'result err';
    };

    ws.onclose = function(event) {
      statusIndicator.textContent = '● Disconnected' + (event.code !== 1000 ? ` (code ${event.code})` : '');
      statusIndicator.className = 'status' + (event.code !== 1000 ? ' err' : '');
      connectBtn.textContent = 'Connect ▸';
      connectBtn.disabled = false;
      tokenInput.disabled = false;
      ws = null;
    };
  }
})();

// Resolve path params like {confidence} or {token}
function resolvePath(pathTemplate, formData) {
  return pathTemplate.replace(/\{(\w+)\}/g, (_, key) => {
    const val = formData[key];
    delete formData[key];
    return encodeURIComponent(val);
  });
}

async function runEndpoint(uid, ep) {
  const form = document.getElementById(uid);
  const statusEl = document.getElementById(`${uid}-status`);
  const resultWrap = document.getElementById(`${uid}-wrap`);
  const resultEl = document.getElementById(`${uid}-result`);
  const btn = form.querySelector('button[type="submit"]');

  const raw = {};
  ep.fields.forEach(f => {
    const input = form.querySelector(`[name="${f.name}"]`);
    const v = input.value.trim();
    if (v !== '') raw[f.name] = v;
  });

  statusEl.innerHTML = '<span class="spinner"></span> Running…';
  statusEl.className = 'status loading';
  resultWrap.style.display = 'none';
  btn.disabled = true;

  try {
    let url, opts;
    const data = {...raw};

    // Parse special fields
    ['num_states','threshold_percentile','min_exceedances','forced_regime',
     'n_simulations','horizon','n_paths','window','max_lag','seed',
     'holding_period','limit','timestamp'].forEach(k => {
      if (data[k] !== undefined) data[k] = parseInt(data[k], 10);
    });
    ['alpha','confidence','target_var_breach','nu','threshold','T',
     'trade_size_usd','max_slippage_pct','max_multiplier','mu',
     'jump_threshold_multiplier','position_value','adv_usd','participation_rate',
     'size_usd','entry_price','pnl','value','size'].forEach(k => {
      if (data[k] !== undefined) data[k] = parseFloat(data[k]);
    });
    ['use_student_t','use_absolute','urgency','use_hawkes','run_debate'].forEach(k => {
      if (data[k] !== undefined) data[k] = data[k] === 'true';
    });

    // Parse JSON fields
    if (typeof data.weights === 'string') {
      try { data.weights = JSON.parse(data.weights); } catch {
        statusEl.textContent = 'Invalid JSON in weights field. Example: {"SOL":0.4,"RAY":0.6}';
        statusEl.className = 'status err';
        btn.disabled = false;
        return;
      }
    }
    if (typeof data.tokens === 'string') {
      data.tokens = data.tokens.split(',').map(s => s.trim()).filter(Boolean);
    }
    if (typeof data.models === 'string' && data.models) {
      data.models = data.models.split(',').map(s => s.trim()).filter(Boolean);
    } else {
      delete data.models;
    }

    const resolvedPath = resolvePath(ep.path, data);

    if (ep.method === 'GET') {
      const params = new URLSearchParams();
      Object.entries(data).forEach(([k,v]) => {
        if (v !== '' && v !== undefined && v !== null) params.set(k, String(v));
      });
      const qs = params.toString();
      url = `${API}${resolvedPath}${qs ? '?' + qs : ''}`;
      opts = { method: 'GET' };
    } else {
      // POST: some endpoints use query params for weights etc.
      // Check if path contains 'portfolio/var' or 'portfolio/marginal' or 'portfolio/stress'
      // or 'portfolio/copula/var' — these use query params for weights
      const queryWeightPaths = ['/portfolio/var','/portfolio/marginal-var','/portfolio/stress-var','/portfolio/copula/var'];
      if (queryWeightPaths.some(p => resolvedPath === p)) {
        const params = new URLSearchParams();
        Object.entries(data).forEach(([k,v]) => {
          if (k === 'weights') {
            Object.entries(v).forEach(([wk,wv]) => params.append(`weights`, `${wk}:${wv}`));
          } else if (v !== '' && v !== undefined && v !== null) {
            params.set(k, String(v));
          }
        });
        // These endpoints expect weights as query param with JSON
        const qp = new URLSearchParams();
        if (data.alpha !== undefined) qp.set('alpha', data.alpha);
        if (data.n_simulations !== undefined) qp.set('n_simulations', data.n_simulations);
        if (data.forced_regime !== undefined) qp.set('forced_regime', data.forced_regime);
        const qs = qp.toString();
        url = `${API}${resolvedPath}${qs ? '?' + qs : ''}`;
        opts = {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data.weights),
        };
      } else {
        url = `${API}${resolvedPath}`;
        opts = {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data),
        };
      }
    }

    const t0 = performance.now();
    const res = await fetch(url, opts);
    const elapsed = ((performance.now() - t0) / 1000).toFixed(2);
    const json = await res.json();

    resultWrap.style.display = 'block';
    resultEl.querySelector('pre').textContent = JSON.stringify(json, null, 2);

    if (res.ok) {
      statusEl.textContent = `✓ ${res.status} — ${elapsed}s`;
      statusEl.className = 'status ok';
      resultEl.className = 'result ok';
      // Track calibration
      if (ep.path === '/calibrate' && raw.token) {
        addCalibratedToken(raw.token);
      }
    } else {
      const detail = json.detail || `HTTP ${res.status}`;
      statusEl.textContent = `✗ ${res.status} — ${detail}`;
      statusEl.className = 'status err';
      resultEl.className = 'result err';
    }
  } catch (err) {
    statusEl.textContent = `✗ Network error: ${err.message}`;
    statusEl.className = 'status err';
    resultWrap.style.display = 'block';
    resultEl.className = 'result err';
    resultEl.querySelector('pre').textContent = err.stack || err.message;
  } finally {
    btn.disabled = false;
  }
}

// Calibration tracker
const calibratedTokens = new Set();
function addCalibratedToken(token) {
  calibratedTokens.add(token.toUpperCase());
  const badge = document.getElementById('cal-tokens');
  if (badge) {
    badge.className = 'badge';
    badge.textContent = [...calibratedTokens].join(', ');
  }
}

// Scroll spy — highlight active nav link
const navLinks = document.querySelectorAll('#main-nav a');
const sectionEls = document.querySelectorAll('.section[id]');
const observer = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      navLinks.forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`#main-nav a[href="#${entry.target.id}"]`);
      if (link) link.classList.add('active');
    }
  });
}, { rootMargin: '-20% 0px -70% 0px', threshold: 0 });
sectionEls.forEach(s => observer.observe(s));

// Health check
async function checkHealth() {
  const el = document.getElementById('health-status');
  try {
    const res = await fetch('/health');
    const data = await res.json();
    el.textContent = `● ${data.service} v${data.version}`;
    el.className = res.ok ? 'ok' : 'err';
  } catch {
    el.textContent = '● Unreachable';
    el.className = 'err';
  }
}
checkHealth();
setInterval(checkHealth, 15000);
</script>
</body>
</html>

